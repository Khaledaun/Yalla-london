# Implementation Plan — Fix All Audit Issues

## Executive Summary

16 issues across 5 severity levels. The #1 blocker: articles generated by the pipeline
are invisible because the blog page reads from static JSON files, not the database.
The sitemap DOES expose these URLs to Google, so Google sees pages that return nothing
useful — actively hurting SEO.

Fix order is designed to unblock revenue first, then prevent crashes, then optimize.

---

## Phase 1: Make Articles Visible to Users (SHOWSTOPPER — blocks all revenue)

### Task 1.1: Fix blog/[slug]/page.tsx to read from database
**File:** `app/blog/[slug]/page.tsx`
**Current:** Reads only from `data/blog-content.ts` + `data/blog-content-extended.ts`
**Fix:**
- Import Prisma and query BlogPost table first
- Fall back to static data if DB record not found (preserves existing static articles)
- generateStaticParams() should include BOTH static slugs AND database slugs
- generateMetadata() should work with both sources
- Keep ISR revalidation (600s) for performance

### Task 1.2: Fix blog listing page to include database articles
**File:** `app/blog/page.tsx`
**Current:** Lists only static posts
**Fix:**
- Query BlogPost table (published=true, deletedAt=null, siteId matching)
- Merge with static posts (deduplicate by slug)
- Sort by created_at descending
- Add pagination (10-20 per page) since article count will grow

### Task 1.3: Align quality score thresholds
**File:** `app/api/cron/content-builder/route.ts` (scoring phase)
**File:** `app/api/cron/content-selector/route.ts` (line 29)
**Current:** Builder passes at ≥50, selector requires ≥60
**Fix:** Both should use 60 as minimum. Or: lower selector to 50 to match builder.
**Recommendation:** Use 50 for both — get content flowing, raise bar later.

---

## Phase 2: Make Articles Earn Money (SHOWSTOPPER — blocks revenue)

### Task 2.1: Create affiliate injection cron job
**New file:** `app/api/cron/affiliate-injection/route.ts`
**Purpose:** Run daily at 09:00 UTC (30 min after content-selector)
**Logic:**
1. Find BlogPosts published in last 48h that still have `<div class="affiliate-placeholder">`
2. For each, call the existing inject logic from `/api/affiliates/inject`
3. Replace placeholders with actual affiliate CTAs (hotel, restaurant, tour links)
4. Create AffiliateAssignment records for tracking
5. Log results to CronJobLog
**Note:** The inject API already exists with full keyword→partner mapping (Booking.com, GetYourGuide, Viator, TheFork, etc.). It just needs to be triggered automatically.

### Task 2.2: Add affiliate injection to content-selector
**File:** `app/api/cron/content-selector/route.ts`
**After creating BlogPost (line ~405):** Call affiliate inject logic inline
**Benefit:** Articles have affiliate links from the moment they're published

### Task 2.3: Wire affiliate rendering in BlogPostClient
**File:** `app/blog/[slug]/BlogPostClient.tsx`
**Current:** Renders content HTML as-is via dangerouslySetInnerHTML
**Fix:** The inject API already produces styled HTML with affiliate CTAs.
Once Task 2.1/2.2 are done, the HTML in the database will already contain
styled affiliate blocks. BlogPostClient just needs to render them (which it
already does via dangerouslySetInnerHTML). No client-side changes needed
unless we want click tracking JS.

### Task 2.4: Add click tracking to affiliate links
**File:** `app/blog/[slug]/BlogPostClient.tsx`
**Add:** Event listener for affiliate link clicks → POST to `/api/track/click`
**Existing:** The click tracking API and AffiliateClick model are fully built.

---

## Phase 3: Fix Crashes (CRITICAL — will error when triggered)

### Task 3.1: Fix admin editor save route
**File:** `app/api/admin/editor/save/route.ts`
**Current:** 16 wrong field names + 4 missing required fields
**Wrong names:** `title` → `title_en`, `titleAr` → `title_ar`, `content` → `content_en`,
`locale` (doesn't exist), `pageType` → `page_type`, `primaryKeyword` → `keywords_json`,
`longTail1/2` → `featured_longtails_json`, `authorityLink1-4` → `authority_links_json`,
`excerpt` → `excerpt_en`, `ogImage` → `featured_image`, `ogVideo` (doesn't exist),
`seoScore` → `seo_score`, `status` (doesn't exist)
**Missing required:** `title_ar`, `content_ar`, `category_id`, `author_id`
**Fix:** Complete rewrite of the create/update data object. Add system user + default
category lookup.

### Task 3.2: Fix content-generation-service.ts
**File:** `lib/content-generation-service.ts`
**Current:** Sets empty `title_ar`/`content_ar` when language='en' — may violate NOT NULL
**Fix:** Set placeholder values: `title_ar: "[Pending Arabic translation]"`,
`content_ar: "[Pending Arabic translation]"`. Use real system user ID lookup
instead of hardcoded `'system-user'`. Look up a real category ID instead of
`'default-category'`.

### Task 3.3: Fix autopilot.ts
**File:** `lib/scheduler/autopilot.ts`
**Same issues as content-generation-service.** Apply same fixes.

### Task 3.4: Fix content-strategy.ts TopicProposal creation
**File:** `lib/seo/content-strategy.ts` (line 226)
**Current:** Uses `source` and `description` (don't exist in schema)
**Missing:** `authority_links_json`, `source_weights_json`
**Fix:** Map to correct field names, add required JSON fields.

---

## Phase 4: Fix Operational Issues (HIGH — wasting resources or hiding failures)

### Task 4.1: Fix maxDuration violations
**Files:** 3 routes declare 300s (exceeds documented 60s Vercel Pro limit)
- `daily-content-generate/route.ts` → change to 60
- `london-news/route.ts` → change to 60
- `fact-verification/route.ts` → change to 60
Add 53s budget guards to all three.

### Task 4.2: Consolidate duplicate indexing
**Current:** 3-4 routes submit URLs to Google/IndexNow:
- `/api/cron/google-indexing` (10 AM daily)
- `/api/cron/seo-agent` (3x daily — 7 AM, 1 PM, 8 PM)
- `/api/seo/cron?task=daily` (7:30 AM daily)
- `/api/seo/workflow/cron` (unscheduled)
**Fix:** Keep seo-agent (3x daily, already handles IndexNow). Remove google-indexing
from vercel.json schedule. Mark seo/cron as supplementary (weekly only).

### Task 4.3: Schedule or remove dead cron routes
**7 routes exist but aren't in vercel.json:**
- `auto-generate` → REMOVE (superseded by daily-content-generate)
- `autopilot` → REMOVE (broken, superseded by content-builder)
- `daily-publish` → ADD to schedule (creates ScheduledContent records)
- `real-time-optimization` → ADD to schedule (daily, flags low-scoring articles)
- `seo-health-report` → ADD to schedule (weekly)
- `site-health-check` → ADD to schedule (daily)
- `social` → SKIP (not priority for launch)

### Task 4.4: Fix daily-content-generate pipeline bypass
**Current:** Creates BlogPost directly, bypassing 8-phase builder/selector pipeline
**Decision needed:** Keep both paths or merge?
**Recommendation:** Keep both for now. daily-content-generate is simpler and already
produces publishable articles. The builder/selector pipeline is higher quality but
more fragile. Run both — daily-content-generate ensures minimum 1 article/day,
builder/selector adds higher-quality articles when working.

### Task 4.5: Secure test-connections.html
**File:** `public/test-connections.html`
**Current:** Publicly accessible, no auth. Shows database status, API health.
**Fix:** Move to admin route (`/admin/test-connections`) behind `withAdminAuth`,
or add token-based access check.

### Task 4.6: Add maxDuration to SEO routes
**25 of 27 SEO routes missing maxDuration declaration.**
They default to 30s via vercel.json override for `app/api/seo/**/*.ts` (60s).
The file-level `export const maxDuration` should match. Add `export const maxDuration = 60`
to the critical ones: `seo/cron`, `seo/workflow/cron`, `seo/audit`.

---

## Phase 5: Dashboard Improvements (MEDIUM — usability for Khaled)

### Task 5.1: Add "Publish All Ready" button to dashboard
**File:** `app/admin/page.tsx` (main dashboard)
**Add:** Button that calls new API endpoint to publish all BlogPosts where
`published = false` and `seo_score >= 50`

### Task 5.2: Add "Run All Crons" button to dashboard
**File:** `app/admin/page.tsx`
**Add:** Button that triggers key cron jobs in sequence:
weekly-topics → content-builder → content-selector → affiliate-injection → seo-agent

### Task 5.3: Add pipeline Kanban view
**File:** `app/admin/topics-pipeline/page.tsx`
**Add:** Visual flow: Topics (count) → Drafts (count) → Ready (count) → Published (count) → Indexed (count)
Each column clickable to see items in that state.

### Task 5.4: Add error notification banner
**File:** `app/admin/page.tsx`
**Add:** Check CronJobLog for failures in last 24h. Show red banner at top
with plain-language error message and link to health page.

---

## Affiliate Partner Setup (Khaled's Action Required)

The system already has hardcoded mappings for these affiliate programs:
- **Hotels:** Booking.com, Agoda
- **Restaurants:** TheFork, OpenTable
- **Tours:** GetYourGuide, Viator
- **Events:** StubHub, Ticketmaster
- **Shopping:** Harrods, Selfridges
- **Transport:** Blacklane
- **Insurance:** Allianz Travel

**What Khaled needs to do (one time):**
1. Sign up for each affiliate program's partner portal
2. Get the affiliate ID / tracking code from each
3. Enter the codes in the dashboard (Admin → Affiliates → Add Partner)

**What the system does automatically (forever after):**
- Matches articles to relevant partners by keyword
- Injects styled affiliate CTAs into article HTML
- Tracks clicks and conversions
- Reports revenue on dashboard

---

## Estimated Effort

| Phase | Tasks | Complexity | Files Changed |
|-------|-------|-----------|---------------|
| Phase 1 | 3 tasks | Medium | 3 files |
| Phase 2 | 4 tasks | Medium | 2-3 files + 1 new |
| Phase 3 | 4 tasks | Low-Medium | 4 files |
| Phase 4 | 6 tasks | Low | 8+ files |
| Phase 5 | 4 tasks | Medium | 3-4 files |

**Priority:** Phase 1 → Phase 2 → Phase 3 → Phase 4 → Phase 5

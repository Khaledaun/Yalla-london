<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yalla London — Connection Validator</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0a0a0a; color: #e0e0e0; padding: 20px; }
  h1 { text-align: center; margin-bottom: 8px; font-size: 1.6rem; color: #fff; }
  .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 0.9rem; }
  .section { background: #141414; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
  .section h2 { font-size: 1rem; color: #aaa; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .test-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
  .test-row:last-child { border-bottom: none; }
  .test-name { flex: 1; font-size: 0.9rem; }
  .test-status { font-size: 0.85rem; font-weight: 600; min-width: 100px; text-align: right; }
  .pass { color: #4ade80; }
  .fail { color: #f87171; }
  .warn { color: #fbbf24; }
  .pending { color: #666; }
  .detail { color: #888; font-size: 0.8rem; margin-top: 2px; word-break: break-all; }
  .summary-bar { display: flex; gap: 24px; justify-content: center; padding: 16px; background: #141414; border: 1px solid #2a2a2a; border-radius: 12px; margin-bottom: 16px; }
  .summary-item { text-align: center; }
  .summary-num { font-size: 2rem; font-weight: 700; }
  .summary-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
  .status-banner { text-align: center; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: 700; margin-top: 16px; }
  .status-ok { background: #052e16; border: 1px solid #166534; color: #4ade80; }
  .status-warn { background: #422006; border: 1px solid #92400e; color: #fbbf24; }
  .status-fail { background: #450a0a; border: 1px solid #991b1b; color: #f87171; }
  button { background: #2563eb; color: white; border: none; padding: 12px 32px; border-radius: 8px; font-size: 1rem; cursor: pointer; display: block; margin: 0 auto 20px; }
  button:hover { background: #1d4ed8; }
  button:disabled { background: #333; color: #666; cursor: not-allowed; }
  .cron-input { background: #1a1a1a; border: 1px solid #333; color: #e0e0e0; padding: 8px 12px; border-radius: 6px; width: 100%; margin-bottom: 12px; font-family: monospace; }
  .cron-input::placeholder { color: #555; }
  .log { background: #0a0a0a; border: 1px solid #222; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; max-height: 300px; overflow-y: auto; margin-top: 12px; white-space: pre-wrap; color: #888; }
  .json-block { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto; margin-top: 8px; white-space: pre-wrap; color: #7ee787; }
  .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; justify-content: center; flex-wrap: wrap; }
  .tab-btn { background: #1a1a1a; border: 1px solid #333; color: #888; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
  .tab-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
</style>
</head>
<body>

<h1>Yalla London — System Validator</h1>
<p class="subtitle">Full pipeline test: GA4, Assets, Pages, SEO, Crons, Database, AI, Content Generation</p>

<div class="tab-bar">
  <button class="tab-btn active" onclick="switchMode('quick')">Quick Test</button>
  <button class="tab-btn" onclick="switchMode('full')">Full Pipeline Test (needs CRON_SECRET)</button>
</div>

<div class="section" id="cronSection" style="display:none">
  <h2>Authentication</h2>
  <input type="password" id="cronSecret" class="cron-input" placeholder="Enter your CRON_SECRET to test cron endpoints and content pipeline...">
</div>

<button id="runBtn" onclick="runAllTests()">Run All Tests</button>

<div class="summary-bar">
  <div class="summary-item"><div class="summary-num pass" id="passCount">-</div><div class="summary-label">Passed</div></div>
  <div class="summary-item"><div class="summary-num warn" id="warnCount">-</div><div class="summary-label">Warnings</div></div>
  <div class="summary-item"><div class="summary-num fail" id="failCount">-</div><div class="summary-label">Failed</div></div>
</div>

<div id="results"></div>
<div id="statusBanner"></div>

<div class="section" style="margin-top:16px">
  <h2>Live Log</h2>
  <div class="log" id="log"></div>
</div>

<script>
let pass = 0, fail = 0, warn = 0;
let testMode = 'quick';

function switchMode(mode) {
  testMode = mode;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-btn')[mode === 'quick' ? 0 : 1].classList.add('active');
  document.getElementById('cronSection').style.display = mode === 'full' ? 'block' : 'none';
}

function log(msg) {
  const el = document.getElementById('log');
  el.textContent += new Date().toISOString().substring(11,19) + ' ' + msg + '\n';
  el.scrollTop = el.scrollHeight;
}

function addSection(id, title) {
  const html = `<div class="section" id="section-${id}"><h2>${title}</h2><div id="tests-${id}"></div></div>`;
  document.getElementById('results').insertAdjacentHTML('beforeend', html);
}

function addResult(sectionId, name, status, detail) {
  if (status === 'pass') pass++;
  else if (status === 'fail') fail++;
  else warn++;

  const cls = status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : 'warn';
  const icon = status === 'pass' ? '\u2713' : status === 'fail' ? '\u2717' : '\u26A0';
  const safeDetail = detail ? escapeHtml(String(detail)) : '';
  const html = `<div class="test-row">
    <div><div class="test-name">${escapeHtml(name)}</div>${safeDetail ? `<div class="detail">${safeDetail}</div>` : ''}</div>
    <div class="test-status ${cls}">${icon} ${status.toUpperCase()}</div>
  </div>`;
  document.getElementById('tests-' + sectionId).insertAdjacentHTML('beforeend', html);
  updateSummary();
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addJsonBlock(sectionId, data) {
  const escaped = escapeHtml(JSON.stringify(data, null, 2));
  const html = `<div class="json-block">${escaped}</div>`;
  document.getElementById('tests-' + sectionId).insertAdjacentHTML('beforeend', html);
}

function updateSummary() {
  document.getElementById('passCount').textContent = pass;
  document.getElementById('warnCount').textContent = warn;
  document.getElementById('failCount').textContent = fail;
}

async function testFetch(url, options = {}) {
  try {
    const resp = await fetch(url, { ...options, signal: AbortSignal.timeout(30000) });
    const text = await resp.text();
    let json = null;
    try { json = JSON.parse(text); } catch {}
    return { ok: resp.ok, status: resp.status, text, json, headers: resp.headers };
  } catch (e) {
    return { ok: false, status: 0, text: e.message, json: null, error: e };
  }
}

async function runAllTests() {
  pass = 0; fail = 0; warn = 0;
  document.getElementById('results').innerHTML = '';
  document.getElementById('statusBanner').innerHTML = '';
  document.getElementById('log').textContent = '';
  document.getElementById('runBtn').disabled = true;
  document.getElementById('runBtn').textContent = 'Testing...';

  const cronSecret = document.getElementById('cronSecret')?.value || '';

  // ── 1. GA4 Client-Side ──
  log('Testing GA4 client-side tracking...');
  addSection('ga4', '1. GA4 Client-Side Tracking');

  const homeResp = await testFetch('/');
  if (homeResp.ok) {
    const gaMatch = homeResp.text.match(/G-[A-Z0-9]{8,12}/);
    if (gaMatch) {
      addResult('ga4', 'GA4 Measurement ID', 'pass', 'Found on homepage: ' + gaMatch[0]);
      if (homeResp.text.includes('googletagmanager.com/gtag')) {
        addResult('ga4', 'gtag.js Script', 'pass', 'Script tag present on homepage');
      } else {
        addResult('ga4', 'gtag.js Script', 'warn', 'ID found but script tag not detected (may load async)');
      }
    } else {
      addResult('ga4', 'GA4 Measurement ID', 'fail', 'Not found in homepage source');
    }
  } else {
    addResult('ga4', 'Homepage Load', 'fail', 'Could not load homepage: HTTP ' + homeResp.status);
  }

  // ── 2. Static Assets (cache-bust to bypass stale CDN 404s) ──
  log('Testing static assets (with cache-bust)...');
  addSection('assets', '2. Static Assets');

  const cacheBust = '?v=' + Date.now();
  const assets = [
    ['/og-image.jpg' + cacheBust, 'OG Image (og-image.jpg)'],
    ['/icons/icon-512x512.png' + cacheBust, 'Icon 512x512'],
    ['/icons/icon-192x192.png' + cacheBust, 'Icon 192x192'],
    ['/favicon.ico' + cacheBust, 'Favicon ICO'],
    ['/favicon.png' + cacheBust, 'Favicon PNG'],
    ['/favicon.svg' + cacheBust, 'Favicon SVG'],
    ['/manifest.json' + cacheBust, 'Manifest'],
  ];

  for (const [url, label] of assets) {
    const resp = await testFetch(url, { method: 'HEAD' });
    if (resp.ok) {
      addResult('assets', label, 'pass', url.split('?')[0] + ' — HTTP ' + resp.status);
    } else {
      addResult('assets', label, 'fail', url.split('?')[0] + ' — HTTP ' + resp.status + ' (may need Cloudflare cache purge)');
    }
  }

  // ── 3. Core Pages ──
  log('Testing core pages...');
  addSection('pages', '3. Core Pages');

  const pages = [
    ['/', 'Homepage'],
    ['/events', 'Events'],
    ['/blog', 'Blog'],
    ['/about', 'About'],
    ['/recommendations', 'Recommendations'],
    ['/sitemap.xml', 'Sitemap XML'],
  ];

  for (const [url, label] of pages) {
    const resp = await testFetch(url);
    if (resp.ok) {
      addResult('pages', label, 'pass', 'HTTP ' + resp.status);
    } else if (resp.status === 404) {
      addResult('pages', label, 'warn', 'HTTP 404');
    } else {
      addResult('pages', label, 'fail', 'HTTP ' + resp.status);
    }
  }

  // ── 4. SEO Meta Tags ──
  log('Testing SEO meta tags...');
  addSection('meta', '4. SEO Meta Tags');

  if (homeResp.ok) {
    const checks = [
      [/property="og:image"[^>]*content="([^"]+)"/, 'og:image'],
      [/property="og:title"[^>]*content="([^"]+)"/, 'og:title'],
      [/property="og:description"[^>]*content="([^"]+)"/, 'og:description'],
      [/rel="canonical"[^>]*href="([^"]+)"/, 'Canonical URL'],
    ];
    for (const [regex, label] of checks) {
      const match = homeResp.text.match(regex);
      if (match) addResult('meta', label, 'pass', match[1].substring(0, 80));
      else addResult('meta', label, 'warn', 'Not found on homepage');
    }
    const jsonLd = homeResp.text.match(/type="application\/ld\+json"/);
    if (jsonLd) addResult('meta', 'JSON-LD Schema', 'pass', 'Present');
    else addResult('meta', 'JSON-LD Schema', 'warn', 'Not found');
  }

  // ── 5. Database ──
  log('Testing database connection...');
  addSection('db', '5. Database Connection');

  const blogApiResp = await testFetch('/api/blog?limit=1');
  if (blogApiResp.ok && blogApiResp.json) {
    const j = blogApiResp.json;
    const count = j.total || j.posts?.length || j.length || '?';
    addResult('db', 'Blog API', 'pass', 'Connected — ' + count + ' posts returned');
  } else if (blogApiResp.status === 404) {
    addResult('db', 'Blog API', 'warn', 'No public blog API (DB may work via internal routes)');
  } else {
    addResult('db', 'Blog API', 'warn', 'HTTP ' + blogApiResp.status);
  }

  // ── 6. AI Provider ──
  log('Testing AI provider...');
  addSection('ai', '6. AI Provider');

  const aiResp = await testFetch('/api/ai/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
  if (aiResp.status === 401 || aiResp.status === 403) {
    addResult('ai', 'AI Generate Endpoint', 'pass', 'Exists (auth-protected)');
  } else if (aiResp.status === 400) {
    addResult('ai', 'AI Generate Endpoint', 'pass', 'Exists (needs valid payload)');
  } else if (aiResp.status === 404) {
    addResult('ai', 'AI Generate Endpoint', 'warn', 'Not found at /api/ai/generate');
  } else if (aiResp.ok) {
    addResult('ai', 'AI Generate Endpoint', 'pass', 'Responded OK');
  } else {
    addResult('ai', 'AI Generate Endpoint', 'warn', 'HTTP ' + aiResp.status);
  }

  // ── Full pipeline tests (need CRON_SECRET) ──
  if (testMode === 'full' && cronSecret) {
    const cronHeaders = { 'Authorization': 'Bearer ' + cronSecret };

    // ── 7. Content Generation Pipeline ──
    log('Testing content generation pipeline...');
    addSection('pipeline', '7. Content Generation Pipeline');

    // Test daily-content-generate (GET = dry run / status check)
    log('  Testing daily-content-generate...');
    const contentResp = await testFetch('/api/cron/daily-content-generate', { headers: cronHeaders });
    if (contentResp.ok && contentResp.json) {
      const j = contentResp.json;
      addResult('pipeline', 'Daily Content Generate', 'pass', j.message || 'OK');
      if (j.sites) addResult('pipeline', 'Active Sites', 'pass', j.sites.map(s => s.name || s.siteId).join(', '));
      if (j.generated !== undefined) addResult('pipeline', 'Articles Generated', 'pass', j.generated + ' articles this run');
      if (j.totalGenerated !== undefined) addResult('pipeline', 'Total Generated Today', 'pass', j.totalGenerated + ' articles today');
      if (j.skippedSites?.length) addResult('pipeline', 'Skipped Sites', 'warn', j.skippedSites.map(s => s.name + ': ' + s.reason).join('; '));
      addJsonBlock('pipeline', j);
    } else if (contentResp.status === 401) {
      addResult('pipeline', 'Daily Content Generate', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      const err = contentResp.json?.error || contentResp.text?.substring(0, 150) || 'Unknown error';
      addResult('pipeline', 'Daily Content Generate', 'fail', 'HTTP ' + contentResp.status + ' — ' + err);
      if (contentResp.json) addJsonBlock('pipeline', contentResp.json);
    }

    // ── 8. Scheduled Publish ──
    log('  Testing scheduled-publish...');
    addSection('publish', '8. Scheduled Publish');

    const publishResp = await testFetch('/api/cron/scheduled-publish', { headers: cronHeaders });
    if (publishResp.ok && publishResp.json) {
      const j = publishResp.json;
      addResult('publish', 'Scheduled Publish', 'pass', j.message || 'OK');
      if (j.published !== undefined) addResult('publish', 'Posts Published', 'pass', j.published + ' posts published this run');
      if (j.pending !== undefined) addResult('publish', 'Pending Schedule', 'pass', j.pending + ' posts pending');
      if (j.nextScheduled?.length) addResult('publish', 'Next Scheduled', 'pass', j.nextScheduled.map(p => p.title?.substring(0,40) + ' @ ' + p.scheduled_at).join('; '));
      addJsonBlock('publish', j);
    } else if (publishResp.status === 401) {
      addResult('publish', 'Scheduled Publish', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      addResult('publish', 'Scheduled Publish', 'warn', 'HTTP ' + publishResp.status + ' — ' + (publishResp.json?.error || publishResp.text?.substring(0,100) || ''));
      if (publishResp.json) addJsonBlock('publish', publishResp.json);
    }

    // ── 9. Weekly Topics ──
    log('  Testing weekly-topics...');
    addSection('topics', '9. Weekly Topics Research');

    const topicsResp = await testFetch('/api/cron/weekly-topics', { headers: cronHeaders });
    if (topicsResp.ok && topicsResp.json) {
      const j = topicsResp.json;
      addResult('topics', 'Weekly Topics', 'pass', j.message || 'OK');
      if (j.topicsGenerated !== undefined) addResult('topics', 'Topics Generated', 'pass', j.topicsGenerated + ' topics');
      if (j.pendingCount !== undefined) addResult('topics', 'Pending Backlog', 'pass', j.pendingCount + ' topics in backlog');
      if (j.skipped) addResult('topics', 'Status', 'pass', 'Skipped (not Sunday / backlog sufficient)');
      addJsonBlock('topics', j);
    } else if (topicsResp.status === 401) {
      addResult('topics', 'Weekly Topics', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      addResult('topics', 'Weekly Topics', 'warn', 'HTTP ' + topicsResp.status + ' — ' + (topicsResp.json?.error || topicsResp.text?.substring(0,100) || ''));
      if (topicsResp.json) addJsonBlock('topics', topicsResp.json);
    }

    // ── 10. Trends Monitor ──
    log('  Testing trends-monitor...');
    addSection('trends', '10. Trends Monitor');

    const trendsResp = await testFetch('/api/cron/trends-monitor', { headers: cronHeaders });
    if (trendsResp.ok && trendsResp.json) {
      const j = trendsResp.json;
      addResult('trends', 'Trends Monitor', 'pass', j.message || 'OK');
      if (j.trendingTopics?.length) addResult('trends', 'Trending Topics', 'pass', j.trendingTopics.length + ' topics found');
      if (j.keywordTrends?.length) addResult('trends', 'Keyword Trends', 'pass', j.keywordTrends.length + ' keywords analyzed');
      if (j.contentOpportunities?.length) addResult('trends', 'Content Opportunities', 'pass', j.contentOpportunities.length + ' opportunities');
      if (j.summary) {
        addResult('trends', 'Rising Keywords', 'pass', (j.summary.risingKeywords || []).join(', ') || 'None');
        addResult('trends', 'Top Opportunities', 'pass', (j.summary.topOpportunities || []).slice(0,3).join(', ') || 'None');
      }
      addJsonBlock('trends', j);
    } else if (trendsResp.status === 401) {
      addResult('trends', 'Trends Monitor', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      addResult('trends', 'Trends Monitor', 'warn', 'HTTP ' + trendsResp.status + ' — ' + (trendsResp.json?.error || trendsResp.text?.substring(0,100) || ''));
      if (trendsResp.json) addJsonBlock('trends', trendsResp.json);
    }

    // ── 11. Analytics Sync ──
    log('  Testing analytics sync...');
    addSection('analytics', '11. Analytics Sync');

    const analyticsResp = await testFetch('/api/cron/analytics', { headers: cronHeaders });
    if (analyticsResp.ok && analyticsResp.json) {
      const j = analyticsResp.json;
      addResult('analytics', 'Analytics Cron', 'pass', j.message || 'OK');
      if (j.reach !== undefined) addResult('analytics', 'Reach Count', 'pass', j.reach.toLocaleString());
      if (j.pageViews !== undefined) addResult('analytics', 'Page Views', 'pass', j.pageViews.toLocaleString());
      if (j.visitors !== undefined) addResult('analytics', 'Visitors', 'pass', j.visitors.toLocaleString());
      addJsonBlock('analytics', j);
    } else if (analyticsResp.status === 401) {
      addResult('analytics', 'Analytics Cron', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      addResult('analytics', 'Analytics Cron', 'warn', 'HTTP ' + analyticsResp.status + ' — ' + (analyticsResp.json?.error || analyticsResp.text?.substring(0,100) || ''));
      if (analyticsResp.json) addJsonBlock('analytics', analyticsResp.json);
    }

    // ── 12. SEO Agent ──
    log('  Testing SEO agent...');
    addSection('seoagent', '12. SEO Agent');

    const seoResp = await testFetch('/api/cron/seo-agent', { headers: cronHeaders });
    if (seoResp.ok && seoResp.json) {
      const j = seoResp.json;
      addResult('seoagent', 'SEO Agent', 'pass', j.message || 'OK');
      addJsonBlock('seoagent', j);
    } else if (seoResp.status === 401) {
      addResult('seoagent', 'SEO Agent', 'fail', 'HTTP 401 — CRON_SECRET mismatch');
    } else {
      addResult('seoagent', 'SEO Agent', 'warn', 'HTTP ' + seoResp.status + ' — ' + (seoResp.json?.error || seoResp.text?.substring(0,100) || ''));
      if (seoResp.json) addJsonBlock('seoagent', seoResp.json);
    }

    // ── 13. SEO Daily Cron ──
    log('  Testing SEO daily cron...');
    const seoCronResp = await testFetch('/api/seo/cron?task=daily', { headers: cronHeaders });
    if (seoCronResp.ok && seoCronResp.json) {
      addResult('seoagent', 'SEO Daily Cron', 'pass', seoCronResp.json.message || 'OK');
    } else if (seoCronResp.status === 401) {
      addResult('seoagent', 'SEO Daily Cron', 'fail', 'HTTP 401');
    } else {
      addResult('seoagent', 'SEO Daily Cron', 'warn', 'HTTP ' + seoCronResp.status);
    }

  } else if (testMode === 'full' && !cronSecret) {
    addSection('pipeline', '7. Content Generation Pipeline');
    addResult('pipeline', 'Pipeline Tests', 'fail', 'Enter CRON_SECRET above and re-run');
  }

  // ── Final Status ──
  log('All tests complete: ' + pass + ' passed, ' + warn + ' warnings, ' + fail + ' failed');

  const banner = document.getElementById('statusBanner');
  if (fail === 0 && warn === 0) {
    banner.innerHTML = '<div class="status-banner status-ok">ALL SYSTEMS GO</div>';
  } else if (fail === 0) {
    banner.innerHTML = '<div class="status-banner status-warn">OPERATIONAL — ' + warn + ' warning(s)</div>';
  } else {
    banner.innerHTML = '<div class="status-banner status-fail">' + fail + ' ISSUE(S) NEED ATTENTION</div>';
  }

  document.getElementById('runBtn').disabled = false;
  document.getElementById('runBtn').textContent = 'Run All Tests Again';
}
</script>
</body>
</html>

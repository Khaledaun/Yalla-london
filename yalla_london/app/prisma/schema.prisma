
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider        = "prisma-client-js"
    binaryTargets   = ["native", "rhel-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?   // bcrypt hashed password
  // RBAC Extensions
  role          String    @default("viewer") // admin, editor, viewer
  permissions   String[]  @default([]) // Additional specific permissions
  isActive      Boolean   @default(true)
  deletedAt     DateTime? // Soft delete support
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  posts         BlogPost[]
  auditLogs     AuditLog[]
  userSessions  UserSession[]
  topicPolicies TopicPolicy[]

  // Premium backend relations
  auditLogsPremium AuditLogPremium[]
  siteMembershipsPremium SiteMemberPremium[]

  // Team & Expertise
  teamMemberProfile TeamMember[]

  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map(name: "users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map(name: "accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map(name: "sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map(name: "verificationtokens")
}

model Category {
  id          String     @id @default(cuid())
  name_en     String
  name_ar     String
  slug        String     @unique
  description_en String?
  description_ar String?
  image_url   String?
  posts       BlogPost[]
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt
}

model BlogPost {
  id           String   @id @default(cuid())
  title_en     String
  title_ar     String
  slug         String   @unique
  excerpt_en   String?
  excerpt_ar   String?
  content_en   String
  content_ar   String
  featured_image String?
  published    Boolean  @default(false)
  category_id  String
  author_id    String
  meta_title_en String?
  meta_title_ar String?
  meta_description_en String?
  meta_description_ar String?
  tags         String[]
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  // Phase 4+ Extensions
  page_type                String?  // guide, place, event, list, faq, news, itinerary
  keywords_json            Json?    // Primary + long-tail keywords
  questions_json           Json?    // PAA-style questions
  authority_links_json     Json?    // Authority source links used (3-4 links)
  featured_longtails_json  Json?    // EXACTLY 2 featured long-tails
  seo_score                Int?     // SEO audit score (0-100)
  og_image_id              String?  // Reference to generated OG image
  place_id                 String?  // Reference to Place if location-based
  
  // Enhanced workflow fields for new dashboard system (temporarily disabled)
  // status                String   @default('draft')
  // promptVersionId       String?
  // generationModel       String?
  // generationProvider    String?
  // generationSource      String? // 'scheduled', 'manual_now', 'upload', 'import'
  
  // Multi-tenant and soft delete
  siteId       String?
  deletedAt    DateTime? // Soft delete support

  category     Category @relation(fields: [category_id], references: [id])
  author       User     @relation(fields: [author_id], references: [id])
  place        Place?   @relation(fields: [place_id], references: [id])

  @@index([page_type])
  @@index([place_id])
  @@index([seo_score])
  @@index([siteId])
  @@index([siteId, published])
  @@index([siteId, created_at])
  @@index([siteId, slug])
  @@index([published])
  @@index([category_id])
  @@index([author_id])
  @@index([created_at])
}

// ─────────────────────────────────────────────────────────
// Information Hub Models
// ─────────────────────────────────────────────────────────

model InformationSection {
  id              String   @id @default(cuid())
  slug            String   @unique
  name_en         String
  name_ar         String
  description_en  String?
  description_ar  String?
  icon            String?
  featured_image  String?
  sort_order      Int      @default(1)
  published       Boolean  @default(true)
  subsections     Json?    // Array of { id, title_en, title_ar, content_en, content_ar }

  siteId          String?
  deletedAt       DateTime?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  articles        InformationArticle[]

  @@index([siteId])
  @@index([published])
  @@index([sort_order])
  @@map("information_sections")
}

model InformationCategory {
  id              String   @id @default(cuid())
  slug            String   @unique
  name_en         String
  name_ar         String
  description_en  String?
  description_ar  String?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  articles        InformationArticle[]

  @@map("information_categories")
}

model InformationArticle {
  id                   String   @id @default(cuid())
  slug                 String   @unique
  section_id           String
  category_id          String
  title_en             String
  title_ar             String
  excerpt_en           String?
  excerpt_ar           String?
  content_en           String   @db.Text
  content_ar           String   @db.Text
  featured_image       String?
  reading_time         Int      @default(5)
  published            Boolean  @default(false)

  // SEO fields
  meta_title_en        String?
  meta_title_ar        String?
  meta_description_en  String?
  meta_description_ar  String?
  tags                 String[]
  keywords             String[]
  page_type            String?  @default("article")
  seo_score            Int?     @default(0)
  faq_questions        Json?    // Array of { question_en, question_ar, answer_en, answer_ar }

  // Multi-tenant and soft delete
  siteId               String?
  deletedAt            DateTime?

  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  section              InformationSection  @relation(fields: [section_id], references: [id])
  category             InformationCategory @relation(fields: [category_id], references: [id])

  @@index([section_id])
  @@index([category_id])
  @@index([siteId])
  @@index([siteId, published])
  @@index([published])
  @@index([page_type])
  @@index([seo_score])
  @@index([created_at])
  @@map("information_articles")
}

// ─────────────────────────────────────────────────────────
// Fact Verification System
// ─────────────────────────────────────────────────────────

model FactEntry {
  id                 String   @id @default(cuid())
  article_type       String   // 'blog' | 'information'
  article_slug       String
  fact_text_en       String   @db.Text
  fact_text_ar       String?  @db.Text
  fact_location      String?  // Section/paragraph identifier within article
  category           String?  // price, schedule, regulation, statistic, contact, address, transport

  // Verification state
  status             String   @default("pending") // pending, verified, outdated, disputed, updated
  confidence_score   Int?     @default(0) // 0-100
  last_verified_at   DateTime?
  next_check_at      DateTime?
  verification_count Int      @default(0)

  // Source tracking
  source_url         String?  @db.Text
  source_name        String?
  source_type        String?  // official_gov, transport_authority, tourism_board, news, review_site
  source_last_checked DateTime?

  // Update tracking
  original_value     String?  @db.Text
  current_value      String?  @db.Text
  updated_value      String?  @db.Text  // Proposed new value if fact changed
  update_applied     Boolean  @default(false)
  update_applied_at  DateTime?

  // Agent metadata
  agent_notes        String?  @db.Text
  verification_log   Json?    // Array of { date, source, result, notes }

  siteId             String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@index([article_type, article_slug])
  @@index([status])
  @@index([next_check_at])
  @@index([category])
  @@index([siteId])
  @@map("fact_entries")
}

// ─────────────────────────────────────────────────────────
// London News Carousel System
// ─────────────────────────────────────────────────────────

model NewsItem {
  id                 String    @id @default(cuid())
  slug               String    @unique
  status             String    @default("draft") // draft, published, archived, expired

  // Content
  headline_en        String
  headline_ar        String
  summary_en         String    @db.Text  // 200 words max
  summary_ar         String    @db.Text
  announcement_en    String    // Short announcement (few words)
  announcement_ar    String

  // Source
  source_name        String    // BBC, TfL, Visit London, etc.
  source_url         String    @db.Text
  source_logo        String?

  // Media
  featured_image     String?
  image_alt_en       String?
  image_alt_ar       String?
  image_credit       String?

  // Classification
  news_category      String    // events, transport, weather, health, festivals, sales, holidays, strikes, popup, general
  relevance_score    Int       @default(50)  // 0-100 how relevant for London travellers
  is_major           Boolean   @default(false)  // Featured/lead story
  urgency            String    @default("normal") // breaking, urgent, normal, low

  // Date relevance
  event_start_date   DateTime? // When the event/news starts
  event_end_date     DateTime? // When it ends (for ongoing events)
  expires_at         DateTime? // When to auto-archive

  // SEO
  meta_title_en      String?
  meta_title_ar      String?
  meta_description_en String?
  meta_description_ar String?
  tags               String[]
  keywords           String[]

  // Internal linking
  related_article_slugs String[] // Slugs of related blog/info articles
  related_shop_slugs    String[] // Slugs of related shop products
  affiliate_link_ids    String[] // IDs of relevant affiliate links

  // Agent metadata
  agent_source       String?   // Which research source found this
  agent_notes        String?   @db.Text
  research_log       Json?     // Array of { source, query, found_at, relevance }

  // Information hub cross-reference
  updates_info_article Boolean  @default(false) // Does this news update an info article?
  affected_info_slugs  String[] // Which info articles should be flagged

  siteId             String?
  published_at       DateTime?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  @@index([status])
  @@index([news_category])
  @@index([is_major])
  @@index([published_at])
  @@index([expires_at])
  @@index([siteId])
  @@index([siteId, status])
  @@map("news_items")
}

model NewsResearchLog {
  id                 String   @id @default(cuid())
  run_type           String   @default("daily") // daily, weekly_deep, manual
  status             String   @default("running") // running, completed, failed
  sources_checked    String[] // List of sources checked
  items_found        Int      @default(0)
  items_published    Int      @default(0)
  items_skipped      Int      @default(0)
  facts_flagged      Int      @default(0) // Facts in info articles that need updating
  duration_ms        Int?
  error_message      String?  @db.Text
  result_summary     Json?    // Detailed results

  siteId             String?
  created_at         DateTime @default(now())

  @@index([run_type])
  @@index([created_at])
  @@index([siteId])
  @@map("news_research_logs")
}

model Recommendation {
  id           String   @id @default(cuid())
  name_en      String
  name_ar      String
  type         String   // hotel, restaurant, attraction
  category     String   // luxury, mid-range, budget
  description_en String
  description_ar String
  address_en   String
  address_ar   String
  phone        String?
  website      String?
  price_range  String?
  rating       Float?
  images       String[]
  features_en  String[]
  features_ar  String[]
  booking_url  String?
  latitude     Float?
  longitude    Float?
  published    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
}

model ContentGeneration {
  id         String   @id @default(cuid())
  prompt     String
  response   String
  type       String   // blog_topic, blog_content, recommendation
  language   String   // en, ar
  used       Boolean  @default(false)
  created_at DateTime @default(now())
}

model ScheduledContent {
  id             String   @id @default(cuid())
  title          String
  content        String   @db.Text
  content_type   String   // blog_post, instagram_post, tiktok_video
  language       String   // en, ar
  category       String?
  tags           String[]
  metadata       Json?
  scheduled_time DateTime
  published_time DateTime?
  status         String   @default("pending") // pending, published, failed, cancelled
  platform       String?  // blog, instagram, tiktok
  published      Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Publishing workflow
  content_id     String?  // ID of the BlogPost to publish
  site_id        String?  // Which site this content belongs to

  // Phase 4+ Extensions
  page_type              String?  // guide, place, event, list, faq, news, itinerary
  topic_proposal_id      String?  // Reference to TopicProposal
  seo_score              Int?     // SEO audit score (0-100)
  generation_source      String?  // manual, topic_proposal, discovery_prompt
  authority_links_used   Json?    // Track which authority links were used
  longtails_used         Json?    // Track which long-tails were used

  topic_proposal TopicProposal? @relation(fields: [topic_proposal_id], references: [id])

  @@index([page_type])
  @@index([topic_proposal_id])
  @@index([seo_score])
  @@index([generation_source])
  @@index([content_id])
  @@index([site_id])
  @@index([scheduled_time])
  @@index([status])
}

// Phase 3.2 - Social Media Embeds
model SocialEmbed {
  id           String   @id @default(cuid())
  platform     String   // instagram, tiktok, facebook, youtube
  url          String   // Original social media URL
  embed_id     String   // Extracted ID from URL
  thumbnail    String?  // Cloud storage path to thumbnail image
  title        String?
  description  String?
  author       String?
  aspect_ratio String   @default("16:9") // For CLS prevention
  metadata     Json?    // Additional platform-specific data
  status       String   @default("active") // active, archived, error
  usage_count  Int      @default(0) // Track where it's used
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
}

// Phase 3.3 - Media Library
model MediaAsset {
  id              String   @id @default(cuid())
  filename        String
  original_name   String
  cloud_storage_path String // S3 key - never store local paths
  url             String   // Public URL for serving
  file_type       String   // image, video, document
  mime_type       String
  file_size       Int      // Size in bytes
  width           Int?
  height          Int?
  alt_text        String?
  title           String?
  description     String?
  tags            String[]
  license_info    String?  // Rights/attribution info
  responsive_urls Json?    // Different sizes (WebP, AVIF variants)
  usage_map       Json?    // Track where asset is used
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Multi-tenant: per-site media pool
  site_id     String?  // null = shared across all sites
  category    String?  // hero, blog, gallery, social, background, logo, icon, product
  folder      String?  // virtual folder path for organization e.g. "london/restaurants"

  // Enhanced fields for video hero support
  isVideo     Boolean  @default(false)
  videoPoster String?  // URL to poster frame
  videoVariants Json?  // Different quality/size variants
  isHeroVideo Boolean  @default(false) // Can be used as homepage hero
  duration    Int?     // Video duration in seconds

  // Soft delete
  deletedAt   DateTime?

  // Relations
  homepage_blocks HomepageBlock[]

  @@index([file_type])
  @@index([created_at])
  @@index([site_id])
  @@index([category])
}

// Phase 3.4 - Homepage Builder
model HomepageBlock {
  id          String   @id @default(cuid())
  type        String   // hero, featured-experiences, events, testimonials, blog-grid, cta
  title_en    String?
  title_ar    String?
  content_en  String?  @db.Text
  content_ar  String?  @db.Text
  config      Json?    // Block-specific configuration
  media_id    String?  // Reference to MediaAsset
  position    Int      // Order on page
  enabled     Boolean  @default(true)
  version     String   @default("draft") // draft, published
  language    String   @default("both") // en, ar, both
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Enhanced fields for video hero support
  heroVideoId String?  // Reference to MediaAsset for video
  heroVideoPoster String?
  heroVideoAutoplay Boolean @default(true)
  heroVideoMuted Boolean @default(true)
  heroVideoLoop Boolean @default(true)
  
  media       MediaAsset? @relation(fields: [media_id], references: [id])
}

model HomepageVersion {
  id          String   @id @default(cuid())
  version_id  String   @unique
  title       String
  blocks_data Json     // Snapshot of all blocks at this version
  published   Boolean  @default(false)
  created_at  DateTime @default(now())
}

// Phase 3.5 - Database Backups & System
model DatabaseBackup {
  id             String   @id @default(cuid())
  backup_name    String
  backup_size    String   // Human readable size
  cloud_storage_path String // S3 path to backup file
  backup_type    String   // scheduled, manual, pre-migration
  tables_count   Int?
  records_count  Int?
  status         String   // completed, failed, in-progress
  error_message  String?
  created_at     DateTime @default(now())
}

model ApiSettings {
  id         String   @id @default(cuid())
  key_name   String   @unique // openai_api_key, google_analytics_id, etc.
  key_value  String
  is_active  Boolean  @default(true)
  last_tested DateTime?
  test_status String?  // success, failed, not_tested
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model ContentScheduleRule {
  id                    String   @id @default(cuid())
  name                  String
  content_type          String   // blog_post, social_post
  language              String   // en, ar, both
  frequency_hours       Int      @default(24) // Generate every X hours
  auto_publish          Boolean  @default(false)
  min_hours_between     Int      @default(6)
  max_posts_per_day     Int      @default(4)
  preferred_times       String[] // ["09:00", "15:00", "21:00"]
  categories            String[] // Categories to generate content for
  is_active             Boolean  @default(true)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
}

// =============================================================================
// PHASE 4A: DATABASE SCHEMA ADDITIONS
// =============================================================================

// =============================================================================
// PHASE 4B: TOPIC RESEARCH & CONTENT PIPELINE MODELS
// =============================================================================

// Weekly Topic Research with Authority Links & Featured Long-tails  
model TopicProposal {
  id                      String   @id @default(cuid())
  site_id                 String?  // Multi-tenant scoping
  title                   String   // Human-readable topic title
  locale                  String   // en, ar
  primary_keyword         String
  longtails               String[] // All long-tail keywords discovered (≥5)
  featured_longtails      String[] // EXACTLY 2 selected for emphasis in articles
  questions               String[] // PAA-style questions
  authority_links_json    Json     // 3-4 items: {url, title, sourceDomain}
  intent                  String   // info, transactional, event
  suggested_page_type     String   // guide, place, event, list, faq, news, itinerary
  suggested_window_start  DateTime?
  suggested_window_end    DateTime?
  source_weights_json     Json     // Citation weights and provenance
  status                  String   @default("planned") // planned, proposed, ready, queued, generating, generated, drafted, approved, published
  confidence_score        Float?   // 0.0 - 1.0
  planned_at              DateTime? // When this topic is scheduled for generation
  evergreen               Boolean  @default(true) // true = evergreen, false = seasonal
  season                  String?  // YYYY-MM format for seasonal content
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  
  // Relations
  scheduled_content       ScheduledContent[]
  
  @@index([site_id])
  @@index([site_id, status])
  @@index([site_id, locale, status])
  @@index([locale, status])
  @@index([suggested_window_start, suggested_window_end])
  @@index([status, confidence_score])
  @@index([planned_at])
}

// Bi-monthly SEO/AEO Rulebook Management
model RulebookVersion {
  id                        String   @id @default(cuid())
  version                   String   @unique // e.g., "2024.09.1"  
  changelog                 String   @db.Text
  weights_json              Json     // SEO scoring weights
  schema_requirements_json  Json     // Required schema per page type
  prompts_json              Json     // Generation prompt templates
  is_active                 Boolean  @default(false)
  created_at                DateTime @default(now())
  
  @@index([is_active])
  @@index([created_at])
}

// Page Type Templates with Required/Optional Blocks
model PageTypeRecipe {
  id                String   @id @default(cuid())
  type              String   @unique // guide, place, event, list, faq, news, itinerary
  required_blocks   String[] // FAQ, Map, KeyFacts, etc.
  optional_blocks   String[] // Gallery, Video, Social, etc.
  schema_plan_json  Json     // Required JSON-LD schemas
  min_word_count    Int      @default(800)
  template_prompts_json Json // Generation prompts per locale
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
}

// =============================================================================
// PHASE 4F: ENHANCED MEDIA & PLACES MODELS
// =============================================================================

// Enhanced Image Assets (optimized for places & content)
model ImageAsset {
  id               String   @id @default(cuid())
  url              String
  cloud_storage_path String // S3 key - matches your MediaAsset pattern
  width            Int
  height           Int
  attribution      String?
  tags             String[]
  place_id         String?
  alt_text         String?
  title            String?
  responsive_variants_json Json? // Different sizes and formats
  usage_count      Int      @default(0)
  seo_keywords     String[] // SEO-relevant keywords for this image
  auto_assigned    Boolean  @default(false) // Was this auto-assigned?
  created_at       DateTime @default(now())
  
  place            Place?   @relation(fields: [place_id], references: [id])
  
  @@index([place_id])
  @@index([tags])
  @@index([auto_assigned])
}

model VideoAsset {
  id               String   @id @default(cuid())
  url              String
  cloud_storage_path String // S3 key
  duration_sec     Int?
  poster_url       String?
  attribution      String?
  tags             String[]
  place_id         String?
  title            String?
  description      String?
  usage_count      Int      @default(0)
  auto_assigned    Boolean  @default(false)
  created_at       DateTime @default(now())
  
  place            Place?   @relation(fields: [place_id], references: [id])
  
  @@index([place_id])
  @@index([tags])
  @@index([auto_assigned])
}

// Places Database (30 London Places + expansion capability)
model Place {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  category      String   // attraction, restaurant, hotel, stadium, market, etc.
  lat           Float?
  lng           Float?
  address       String?
  official_url  String?
  short_desc    String?
  tags          String[]
  metadata_json Json?    // Additional place-specific data
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  // Relations
  blog_posts    BlogPost[]
  image_assets  ImageAsset[]
  video_assets  VideoAsset[]
  
  @@index([category])
  @@index([tags])
  @@index([slug])
}

// =============================================================================
// PHASE 4E: ANALYTICS & PERFORMANCE TRACKING
// =============================================================================

// Analytics Snapshot Caching (GA4 & GSC data)
model AnalyticsSnapshot {
  id               String   @id @default(cuid())
  site_id          String?  // For future multi-site support
  date_range       String   // 7d, 28d
  data_json        Json     // GA4 & GSC aggregated data
  indexed_pages    Int      @default(0) // From GSC - triggers backlink offers at ≥40
  top_queries      Json     // Top search queries
  performance_metrics Json  // CTR, impressions, etc.
  created_at       DateTime @default(now())
  
  @@index([date_range])
  @@index([created_at])
  @@index([indexed_pages])
}

// SEO Audit Results with Auto-fixes & Internal Link Offers
model SeoAuditResult {
  id                String   @id @default(cuid())
  content_id        String   // BlogPost or ScheduledContent ID
  content_type      String   // blog_post, scheduled_content
  score             Int      // Overall SEO score (0-100)
  breakdown_json    Json     // Detailed scoring breakdown
  suggestions       Json     // Array of suggestions
  quick_fixes       Json     // Auto-applicable fixes
  internal_link_offers Json? // When indexed_pages >= 40
  authority_links_used Json? // Track authority link usage
  longtails_coverage Json?  // Track featured long-tail usage
  audit_version     String   @default("1.0")
  created_at        DateTime @default(now())
  
  @@index([content_id, content_type])
  @@index([score])
  @@index([created_at])
}

// =============================================================================
// PHASE 4 FEATURE MODELS
// =============================================================================

// Media Enrichment tracking with AI-powered enhancements
model MediaEnrichment {
  id                String   @id @default(cuid())
  media_id          String   @unique
  alt_text_original String?
  alt_text_enhanced String?
  title_enhanced    String?
  description_enhanced String?
  tags_ai           String[]
  color_palette     Json?    // Dominant colors extracted
  composition_data  Json?    // AI analysis of composition
  accessibility_score Int?   // 0-100 accessibility score
  seo_optimized     Boolean  @default(false)
  processing_status String   @default("pending") // pending, processing, completed, failed
  ai_metadata       Json?    // Additional AI-generated metadata

  // AI-detected structured categories
  content_type      String?  // landscape, cityscape, food, interior, person, activity, product, abstract
  use_case          String?  // hero, blog-featured, thumbnail, gallery, social, background
  mood              String?  // luxury, casual, vibrant, serene, dramatic, cozy, professional
  destination_tags  String[] // e.g. ["london", "restaurant", "halal", "fine-dining"]
  objects_detected  String[] // e.g. ["building", "food", "person", "car"]
  text_detected     String?  // OCR text found in image
  brand_compliance  Int?     // 0-100 how well image fits site brand

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([processing_status])
  @@index([seo_optimized])
  @@index([created_at])
  @@index([content_type])
  @@index([use_case])
}

// Prompt Template Management with versioning and locale support
model PromptTemplate {
  id             String   @id @default(cuid())
  name           String
  category       String   // content_generation, seo_audit, topic_research, media_description
  template_en    String   @db.Text
  template_ar    String?  @db.Text
  variables      Json     // Template variables and their types
  version        String   @default("1.0")
  locale_overrides Json?  // Locale-specific customizations
  is_active      Boolean  @default(true)
  created_by     String?  // User ID
  usage_count    Int      @default(0)
  last_used_at   DateTime?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  @@index([category, is_active])
  @@index([version])
  @@index([usage_count])
  @@unique([name, version])
}

// =============================================================================
// PHASE 4G: MULTI-SITE ARCHITECTURE (PREPARATORY)
// =============================================================================

// Multi-Site Support (extends your existing brand system)
model Site {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?  @unique
  theme_id    String?
  settings_json Json   // Site-specific configuration
  homepage_json Json?  // Homepage builder configuration
  logo_url    String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Localization
  default_locale String  @default("en")  // "en" | "ar"
  direction      String  @default("ltr") // "ltr" | "rtl"

  // Branding
  favicon_url     String?
  primary_color   String? @default("#0C4A6E")
  secondary_color String? @default("#0EA5E9")

  // Features
  features_json   Json?   // Per-site feature flags

  // Relations
  site_members SiteMember[]
  site_themes  SiteTheme?   @relation(fields: [theme_id], references: [id])
  team_members TeamMember[]
  domains      Domain[]
  events       Event[]

  @@index([is_active])
  @@index([slug])
}

model SiteTheme {
  id           String   @id @default(cuid())
  name         String
  tokens_json  Json     // CSS variables and theme tokens (extends your brand system)
  preview_url  String?
  created_at   DateTime @default(now())
  
  // Relations
  sites        Site[]
}

model SiteMember {
  id      String   @id @default(cuid())
  site_id String
  user_id String
  role    String   // OWNER, MANAGER, WORKER, ANALYST
  
  site    Site     @relation(fields: [site_id], references: [id], onDelete: Cascade)
  
  @@unique([site_id, user_id])
}

// =============================================================================
// ENTERPRISE SECURITY & ANALYTICS EXTENSIONS
// =============================================================================

// Audit Log for enterprise compliance and security
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // login, logout, create, update, delete, access, export
  resource    String?  // table or endpoint accessed
  resourceId  String?  // specific record ID
  details     Json?    // additional context
  ipAddress   String?
  userAgent   String?
  success     Boolean  @default(true)
  errorMessage String?
  timestamp   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([resource])
}

// Enterprise Analytics Events Tracking
model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventName   String
  category    String   @default("engagement")
  label       String?
  value       Float?
  userId      String?
  sessionId   String?
  properties  Json?    // Additional event properties
  timestamp   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  referer     String?
  
  @@index([eventName])
  @@index([category])
  @@index([timestamp])
  @@index([userId])
  @@index([sessionId])
}

// System Performance and Usage Metrics
model SystemMetrics {
  id          String   @id @default(cuid())
  metricName  String
  metricValue Float
  metricUnit  String?  // requests, ms, bytes, percentage
  tags        Json?    // Additional context/dimensions
  timestamp   DateTime @default(now())
  
  @@index([metricName])
  @@index([timestamp])
}

// User Sessions for enhanced security tracking
model UserSession {
  id          String   @id @default(cuid())
  userId      String
  sessionToken String  @unique
  ipAddress   String?
  userAgent   String?
  lastActivity DateTime @default(now())
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@index([lastActivity])
}

// =============================================================================
// PHASE 4C: UNIFIED BACKEND UX + FEATURE PLAN MODELS
// =============================================================================

// Topic Policy Management (balancer quotas, publishing rules)
model TopicPolicy {
  id                    String   @id @default(cuid())
  site_id               String?  // Multi-tenant scoping
  name                  String
  policy_type           String   // quota_balancer, publishing_rules, content_quality
  rules_json            Json     // Policy-specific rules and thresholds
  quotas_json           Json?    // Daily/weekly content quotas by category
  priorities_json       Json?    // Category priority weights
  auto_approval_rules   Json?    // Auto-approval criteria
  violation_actions     String[] // warn, reject, quarantine, escalate
  is_active             Boolean  @default(true)
  effective_from        DateTime @default(now())
  effective_until       DateTime?
  created_by            String
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
  
  user                  User     @relation(fields: [created_by], references: [id])
  
  @@index([site_id])
  @@index([policy_type])
  @@index([is_active])
  @@index([effective_from, effective_until])
}

// CRM Subscriber Management with Double Opt-in
model Subscriber {
  id                    String      @id @default(cuid())
  site_id               String?     // Multi-tenant scoping
  email                 String
  status                SubscriberStatus @default(PENDING)
  source                String?     // exit_intent, newsletter_signup, content_gate
  preferences_json      Json?       // Newsletter preferences, frequency, topics
  metadata_json         Json?       // UTM params, user agent, IP (anonymized)
  double_optin_token    String?     @unique
  double_optin_sent_at  DateTime?
  confirmed_at          DateTime?
  unsubscribed_at       DateTime?
  unsubscribe_reason    String?
  last_campaign_sent    DateTime?
  engagement_score      Float?      // Calculated engagement metrics
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  
  // Relations
  consent_logs          ConsentLog[]
  
  @@unique([site_id, email])
  @@index([site_id])
  @@index([status])
  @@index([source])
  @@index([created_at])
}

enum SubscriberStatus {
  PENDING
  CONFIRMED
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

// GDPR/Privacy Consent Logging
model ConsentLog {
  id                String   @id @default(cuid())
  site_id           String?  // Multi-tenant scoping  
  subscriber_id     String
  consent_type      String   // newsletter, analytics, marketing, functional
  consent_version   String   // Consent form version for compliance
  action            String   // granted, withdrawn, updated
  legal_basis       String   // consent, legitimate_interest, contract
  processing_purposes String[] // marketing, analytics, personalization
  data_categories   String[] // email, behavioral, preferences
  consent_text      String?  @db.Text // Actual consent text shown to user
  ip_address        String?  // For audit trail (anonymized after 30 days)
  user_agent        String?
  timestamp         DateTime @default(now())
  
  subscriber        Subscriber @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  
  @@index([site_id])
  @@index([subscriber_id])
  @@index([consent_type])
  @@index([action])
  @@index([timestamp])
}

// LLM Provider Management (encrypted API keys)
model ModelProvider {
  id                String   @id @default(cuid())
  site_id           String?  // Multi-tenant scoping
  name              String   // openai, anthropic, google, perplexity
  display_name      String   // "OpenAI GPT-4", "Claude 3.5 Sonnet"
  provider_type     String   // llm, search, vision, embedding
  api_endpoint      String?
  api_key_encrypted String?  @db.Text // AES-GCM encrypted
  api_version       String?
  rate_limits_json  Json?    // Rate limiting configuration
  cost_per_token    Float?   // For cost tracking
  capabilities      String[] // text_generation, image_analysis, search
  model_config_json Json?    // Model-specific parameters
  is_active         Boolean  @default(true)
  last_tested_at    DateTime?
  test_status       String?  // success, failed, pending
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relations
  model_routes      ModelRoute[]
  
  @@index([site_id])
  @@index([provider_type])
  @@index([is_active])
}

// LLM Request Routing and Load Balancing
model ModelRoute {
  id                  String   @id @default(cuid())
  site_id             String?  // Multi-tenant scoping
  route_name          String   // topic_research, content_generation, seo_audit
  primary_provider_id String
  fallback_provider_id String?
  routing_rules_json  Json     // Load balancing, failover rules
  cost_optimization   Boolean  @default(false)
  quality_threshold   Float?   // Minimum quality score to accept
  max_retries         Int      @default(3)
  timeout_seconds     Int      @default(30)
  is_active           Boolean  @default(true)
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  
  primary_provider    ModelProvider @relation(fields: [primary_provider_id], references: [id])
  
  @@index([site_id])
  @@index([route_name])
  @@index([is_active])
}

// Background Job Management and Monitoring
model BackgroundJob {
  id              String   @id @default(cuid())
  site_id         String?  // Multi-tenant scoping
  job_name        String   // backlink_inspector, topic_balancer, analytics_sync, cleanup
  job_type        String   // scheduled, triggered, manual
  schedule_cron   String?  // Cron expression for scheduled jobs
  parameters_json Json?    // Job-specific parameters
  status          String   @default("pending") // pending, running, completed, failed, cancelled
  started_at      DateTime?
  completed_at    DateTime?
  duration_ms     Int?
  result_json     Json?    // Job results and metrics
  error_message   String?  @db.Text
  retry_count     Int      @default(0)
  max_retries     Int      @default(3)
  next_run_at     DateTime?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@index([site_id])
  @@index([job_name])
  @@index([status])
  @@index([next_run_at])
  @@index([created_at])
}

// Exit Intent and Engagement Tracking
model ExitIntentImpression {
  id                String   @id @default(cuid())
  site_id           String?  // Multi-tenant scoping
  session_id        String   // Anonymous session tracking
  page_url          String
  user_agent        String?
  impression_type   String   // newsletter_modal, survey, special_offer
  trigger_event     String   // mouse_leave, scroll_up, time_on_page
  shown_at          DateTime @default(now())
  action_taken      String?  // subscribed, dismissed, ignored
  action_taken_at   DateTime?
  conversion_value  Float?   // If converted, track value
  ttl_expires_at    DateTime // Auto-cleanup after X days
  
  @@index([site_id])
  @@index([session_id])
  @@index([shown_at])
  @@index([ttl_expires_at]) // For cleanup job
}

// Enhanced User model relations for Phase 4C
// (Adding this to avoid schema conflicts - the User model already exists above)
model UserExtended {
  id                String   @id @default(cuid())
  user_id           String   @unique // Reference to existing User
  site_memberships  Json?    // Multi-site access control
  feature_preferences Json?  // User-specific feature toggles
  notification_settings Json? // Email, in-app notification preferences
  last_activity_at  DateTime?
  activity_streak   Int      @default(0)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@index([user_id])
  @@index([last_activity_at])
}

// =============================================================================
// PREMIUM BACKEND MODELS - PHASE 4 COMPLETE
// =============================================================================

// Enhanced Site model with premium features
model SitePremium {
  id                String   @id @default(cuid())
  siteId            String   @unique // Maps to existing Site if multi-tenant
  name              String
  slug              String   @unique
  domain            String?  @unique
  theme_id          String?
  settings_json     Json     // Site-specific configuration with feature flags
  logo_url          String?
  favicon_url       String?
  is_active         Boolean  @default(true)
  
  // Premium settings
  locale_settings   Json?    // Per-site locale configuration
  brand_settings    Json?    // Brand colors, fonts, etc.
  seo_settings      Json?    // Default SEO configuration
  analytics_settings Json?   // GA4, GSC, other analytics
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  site_themes       SiteThemePremium? @relation(fields: [theme_id], references: [id])
  site_members      SiteMemberPremium[]
  homepage_versions HomepageVersionPremium[]
  audit_logs        AuditLogPremium[]
  changes           ChangePremium[]
  affiliate_partners AffiliatePartner[]
  agreements        Agreement[]
  job_runs          JobRun[]
  
  @@index([is_active])
  @@index([slug])
  @@index([deleted_at])
  @@index([createdById])
}

// Enhanced SiteTheme with live preview capability
model SiteThemePremium {
  id                String   @id @default(cuid())
  siteId            String
  name              String
  tokens_json       Json     // CSS variables and theme tokens
  preview_url       String?
  is_active         Boolean  @default(false)
  
  // Versioning
  version           String   @default("1.0.0")
  parent_theme_id   String?
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  sites             SitePremium[]
  parent_theme      SiteThemePremium? @relation("ThemeVersions", fields: [parent_theme_id], references: [id])
  child_themes      SiteThemePremium[] @relation("ThemeVersions")
  
  @@index([siteId])
  @@index([is_active])
  @@index([deleted_at])
}

// Enhanced HomepageVersion with diff capability
model HomepageVersionPremium {
  id                String   @id @default(cuid())
  siteId            String
  version_id        String   @unique
  title             String
  blocks_data       Json     // Snapshot of all blocks at this version
  diff_from_previous Json?   // Diff from previous version for rollback
  published         Boolean  @default(false)
  is_draft          Boolean  @default(true)
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId])
  @@index([published])
  @@index([is_draft])
  @@index([deleted_at])
}

// Enhanced Audit Log with full traceability
model AuditLogPremium {
  id                String   @id @default(cuid())
  siteId            String
  userId            String?
  action            String   // login, logout, create, update, delete, access, export
  resource          String?  // table or endpoint accessed
  resourceId        String?  // specific record ID
  details           Json?    // additional context
  ip_address        String?
  user_agent        String?
  success           Boolean  @default(true)
  error_message     String?
  trace_id          String?  // For distributed tracing
  
  // Reversibility
  reversible        Boolean  @default(false)
  reverse_operation Json?    // Data needed to reverse this operation
  reversed_at       DateTime?
  reversed_by       String?
  
  timestamp         DateTime @default(now())
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user              User?     @relation(fields: [userId], references: [id])
  
  @@index([siteId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([resource])
  @@index([reversible])
}

// Change tracking for optimistic updates and undo
model ChangePremium {
  id                String   @id @default(cuid())
  siteId            String
  operation_id      String   @unique // Client-side operation ID
  operation_type    String   // create, update, delete, bulk_update
  table_name        String
  record_id         String?
  old_data          Json?    // Previous state
  new_data          Json?    // New state
  diff_data         Json?    // Specific changes
  
  // Status
  status            String   @default("pending") // pending, applied, failed, reverted
  applied_at        DateTime?
  reverted_at       DateTime?
  
  // Metadata
  createdById       String
  created_at        DateTime @default(now())
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId])
  @@index([operation_id])
  @@index([status])
  @@index([table_name])
  @@index([created_at])
}

// Enhanced Site membership with premium roles
model SiteMemberPremium {
  id                String   @id @default(cuid())
  siteId            String
  userId            String
  role              String   // OWNER, ADMIN, EDITOR, REVIEWER, VIEWER
  permissions       Json?    // Additional granular permissions
  access_level      String   @default("standard") // standard, elevated, admin
  
  // Access control
  is_active         Boolean  @default(true)
  invited_at        DateTime?
  joined_at         DateTime?
  last_access_at    DateTime?
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([siteId, userId])
  @@index([siteId])
  @@index([userId])
  @@index([role])
  @@index([is_active])
}

// Affiliate Partner Management
model AffiliatePartner {
  id                String   @id @default(cuid())
  siteId            String
  name              String
  slug              String
  partner_type      String   // hotel, restaurant, attraction, service
  api_endpoint      String?
  api_key_encrypted String?  @db.Text // AES-GCM encrypted
  commission_rate   Float?
  contact_info      Json?
  
  // Status
  is_active         Boolean  @default(true)
  last_sync_at      DateTime?
  sync_status       String?  // success, failed, pending
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  widgets           AffiliateWidget[]
  assignments       AffiliateAssignment[]
  
  @@unique([siteId, slug])
  @@index([siteId])
  @@index([partner_type])
  @@index([is_active])
}

// Affiliate Widget Configuration
model AffiliateWidget {
  id                String   @id @default(cuid())
  siteId            String
  partner_id        String
  name              String
  widget_type       String   // banner, carousel, search, comparison
  config_json       Json     // Widget-specific configuration
  preview_url       String?
  
  // Placement
  placement_rules   Json?    // Where widget can be placed
  auto_placement    Boolean  @default(false)
  
  // Status
  is_active         Boolean  @default(true)
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  partner           AffiliatePartner @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  assignments       AffiliateAssignment[]
  
  @@index([siteId])
  @@index([partner_id])
  @@index([widget_type])
  @@index([is_active])
}

// Affiliate Assignment Matrix
model AffiliateAssignment {
  id                String   @id @default(cuid())
  siteId            String
  partner_id        String
  widget_id         String?
  content_id        String   // BlogPost, Place, etc.
  content_type      String   // blog_post, place, page
  
  // Assignment rules
  placement_data    Json?    // Specific placement within content
  auto_assigned     Boolean  @default(false)
  priority          Int      @default(1)
  
  // Performance
  impressions       Int      @default(0)
  clicks            Int      @default(0)
  conversions       Int      @default(0)
  revenue           Float    @default(0)
  
  // Status
  is_active         Boolean  @default(true)
  
  // Metadata
  createdById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relations
  partner           AffiliatePartner @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  widget            AffiliateWidget? @relation(fields: [widget_id], references: [id], onDelete: SetNull)
  
  @@index([siteId])
  @@index([partner_id])
  @@index([content_id, content_type])
  @@index([is_active])
}

// Agreement and Contract Management
model Agreement {
  id                String   @id @default(cuid())
  siteId            String
  title             String
  agreement_type    String   // affiliate, partnership, service, privacy, terms
  content           String   @db.Text
  version           String   @default("1.0")
  
  // Status
  status            String   @default("draft") // draft, active, expired, superseded
  effective_date    DateTime?
  expiry_date       DateTime?
  
  // Signatures
  signatures        Json?    // Digital signature data
  signed_at         DateTime?
  signed_by         String?
  
  // Metadata
  createdById       String
  updatedById       String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  deleted_at        DateTime?
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId])
  @@index([agreement_type])
  @@index([status])
  @@index([effective_date])
}

// Background Job Execution Tracking
model JobRun {
  id                String   @id @default(cuid())
  siteId            String
  job_name          String   // backlink_inspector, topic_balancer, analytics_sync
  job_type          String   // scheduled, triggered, manual
  schedule_cron     String?  // Cron expression for scheduled jobs
  parameters_json   Json?    // Job-specific parameters
  
  // Execution
  status            String   @default("pending") // pending, running, completed, failed, cancelled
  started_at        DateTime?
  completed_at      DateTime?
  duration_ms       Int?
  result_json       Json?    // Job results and metrics
  error_message     String?  @db.Text
  
  // Retry logic
  retry_count       Int      @default(0)
  max_retries       Int      @default(3)
  next_retry_at     DateTime?
  
  // Scheduling
  next_run_at       DateTime?
  
  // Metadata
  createdById       String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relations
  site              SitePremium @relation(fields: [siteId], references: [id], onDelete: Cascade)
  
  @@index([siteId])
  @@index([job_name])
  @@index([status])
  @@index([next_run_at])
  @@index([next_retry_at])
  @@index([created_at])
}

// SEO Tables
model SeoMeta {
  id                  String   @id @default(cuid())
  pageId              String   @unique
  url                 String?
  title               String
  description         String
  canonical           String?
  metaKeywords        String?
  ogTitle             String?
  ogDescription       String?
  ogImage             String?
  ogType              String   @default("website")
  twitterTitle        String?
  twitterDescription  String?
  twitterImage        String?
  twitterCard         String   @default("summary_large_image")
  robotsMeta          String   @default("index,follow")
  schemaType          String?
  structuredData      Json?
  hreflangAlternates  Json?
  seoScore            Int      @default(0)
  lastAuditAt         DateTime?
  auditIssues         String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  internalLinks       SeoInternalLink[] @relation("SourcePage")
  targetLinks         SeoInternalLink[] @relation("TargetPage")
  contentAnalysis     SeoContentAnalysis?
  healthMetrics       SeoHealthMetric[]
  pageMetrics         SeoPageMetric[]
  hreflangEntries     SeoHreflangEntry[]
  structuredDataEntries SeoStructuredData[]

  @@map(name: "seo_meta")
}


model SeoRedirect {
  id         String   @id @default(cuid())
  sourceUrl  String   @unique
  targetUrl  String
  statusCode Int      @default(301)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map(name: "seo_redirects")
}

model SeoInternalLink {
  id              String   @id @default(cuid())
  sourcePageId    String
  targetPageId    String
  anchorText      String
  context         String?
  relevanceScore  Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sourcePage      SeoMeta  @relation("SourcePage", fields: [sourcePageId], references: [pageId], onDelete: Cascade)
  targetPage      SeoMeta  @relation("TargetPage", fields: [targetPageId], references: [pageId], onDelete: Cascade)

  @@map(name: "seo_internal_links")
}

model SeoKeyword {
  id            String   @id @default(cuid())
  keyword       String   @unique
  searchVolume  Int?
  competition   Float?
  difficulty    Int?
  lastUpdated   DateTime @default(now())

  @@map(name: "seo_keywords")
}

model SeoContentAnalysis {
  id               String   @id @default(cuid())
  contentId        String   @unique
  readabilityScore Float?
  keywordDensity   Json?
  sentimentScore   Float?
  analysisResult   Json?
  analyzedAt       DateTime @default(now())

  // Relations
  seoMeta          SeoMeta  @relation(fields: [contentId], references: [pageId], onDelete: Cascade)

  @@map(name: "seo_content_analysis")
}

model SeoReport {
  id          String    @id @default(cuid())
  site_id     String?   // Multi-tenant: which site this report is for
  reportType  String    // sitemap, analytics, performance, health
  generatedAt DateTime  @default(now())
  data        Json
  periodStart DateTime?
  periodEnd   DateTime?

  @@index([site_id])
  @@index([site_id, reportType])
  @@index([reportType, generatedAt])
  @@map(name: "seo_reports")
}

model SeoHealthMetric {
  id        String   @id @default(cuid())
  pageId    String?
  url       String?
  metricName String
  value     Float
  timestamp DateTime @default(now())

  // Relations
  seoMeta   SeoMeta? @relation(fields: [pageId], references: [pageId], onDelete: SetNull)

  @@map(name: "seo_health_metrics")
}

model SeoPageMetric {
  id              String   @id @default(cuid())
  pageId          String
  url             String
  lcp             Float?   // Largest Contentful Paint
  fid             Float?   // First Input Delay
  cls             Float?   // Cumulative Layout Shift
  fcp             Float?   // First Contentful Paint
  tti             Float?   // Time to Interactive
  indexed         Boolean?
  lastCrawled     DateTime?
  mobileFriendly  Boolean?
  updatedAt       DateTime @updatedAt

  // Relations
  seoMeta         SeoMeta  @relation(fields: [pageId], references: [pageId], onDelete: Cascade)

  @@map(name: "seo_page_metrics")
}

model SeoSitemapEntry {
  id             String   @id @default(cuid())
  url            String   @unique
  lastModified   DateTime
  changeFrequency String?
  priority       Float?
  sitemapType    String   // index, pages, articles, events, images
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map(name: "seo_sitemap_entries")
}

model SeoHreflangEntry {
  id        String   @id @default(cuid())
  pageId    String
  lang      String
  url       String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seoMeta   SeoMeta  @relation(fields: [pageId], references: [pageId], onDelete: Cascade)

  @@map(name: "seo_hreflang_entries")
}

model SeoStructuredData {
  id         String   @id @default(cuid())
  pageId     String
  schemaType String
  jsonData   Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  seoMeta    SeoMeta  @relation(fields: [pageId], references: [pageId], onDelete: Cascade)

  @@map(name: "seo_structured_data")
}

// =============================================================================
// COMMAND CENTER MODELS
// =============================================================================

// Feature Flags for Command Center
model FeatureFlag {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  enabled     Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  @@map(name: "feature_flags")
}

// Encrypted Credentials for API & Security
model Credential {
  id                String   @id @default(cuid())
  site_id           String?  // Multi-tenant scoping
  name              String   // e.g., "OpenAI API Key", "Google Analytics"
  type              String   // api_key, oauth_token, webhook_secret
  encrypted_value   String   @db.Text // AES-256-GCM encrypted
  last_used_at      DateTime?
  status            String   @default("active") // active, inactive, expired
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@index([site_id])
  @@index([type])
  @@index([status])
  @@map(name: "credentials")
}

// Site Configuration for Homepage Builder
model SiteConfig {
  id                String   @id @default(cuid())
  site_id           String   @unique
  homepage_json     Json?    // Homepage builder configuration
  hero_video_url    String?  // Hero video URL
  hero_mobile_video_url String? // Mobile hero video URL
  hero_poster_url   String?  // Video poster image
  hero_autoplay     Boolean  @default(true)
  hero_muted        Boolean  @default(true)
  hero_loop         Boolean  @default(true)
  hero_cta_label    String?
  hero_cta_href     String?
  hero_headline     String?
  hero_subheadline  String?
  theme_config      Json?    // Theme configuration
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@map(name: "site_config")
}

// Content Import Tracking
model ContentImport {
  id                String   @id @default(cuid())
  site_id           String?
  import_type       String   // csv, markdown, html, manual
  source_file       String?  // Original filename
  status            String   @default("pending") // pending, processing, completed, failed
  imported_count    Int      @default(0)
  failed_count      Int      @default(0)
  error_message     String?  @db.Text
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@index([site_id])
  @@index([status])
  @@map(name: "content_imports")
}

// =============================================================================
// TEAM & EXPERTISE SYSTEM
// =============================================================================

model TeamMember {
  id              String   @id @default(cuid())
  site_id         String?  // null = global team member across sites
  user_id         String?  // optional link to User for login access

  // Profile
  name_en         String
  name_ar         String?
  slug            String   @unique
  title_en        String   // "Senior Travel Content Strategist"
  title_ar        String?
  bio_en          String   @db.Text
  bio_ar          String?  @db.Text

  // Media
  avatar_url      String?
  cover_image_url String?

  // Contact (optional public display)
  email_public    String?
  linkedin_url    String?
  twitter_url     String?
  instagram_url   String?
  website_url     String?

  // Status
  is_active       Boolean  @default(true)
  is_featured     Boolean  @default(false)
  display_order   Int      @default(0)

  // Relations
  site            Site?    @relation(fields: [site_id], references: [id], onDelete: SetNull)
  user            User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  expertise       TeamMemberExpertise[]
  content_credits ContentCredit[]

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([site_id, is_active])
  @@index([is_featured])
  @@map("team_members")
}

model Skill {
  id          String        @id @default(cuid())
  slug        String        @unique
  name_en     String
  name_ar     String?
  category    SkillCategory
  description_en String?
  description_ar String?
  icon        String?       // Lucide icon name (e.g., "code", "palette", "brain")
  color       String?       // Hex color for badge (e.g., "#3B82F6")
  is_active   Boolean       @default(true)
  display_order Int         @default(0)

  // Relations
  expertise   TeamMemberExpertise[]

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([category])
  @@index([is_active])
  @@map("skills")
}

model TeamMemberExpertise {
  id               String      @id @default(cuid())
  team_member_id   String
  skill_id         String

  proficiency      Proficiency @default(EXPERT)
  years_experience Int?
  description_en   String?     // Context like "Led 50+ projects"
  description_ar   String?
  is_primary       Boolean     @default(false)  // Top 3-5 highlighted skills
  display_order    Int         @default(0)

  // Relations
  team_member      TeamMember  @relation(fields: [team_member_id], references: [id], onDelete: Cascade)
  skill            Skill       @relation(fields: [skill_id], references: [id], onDelete: Cascade)

  created_at       DateTime    @default(now())
  updated_at       DateTime    @updatedAt

  @@unique([team_member_id, skill_id])
  @@index([team_member_id])
  @@index([skill_id])
  @@index([is_primary])
  @@map("team_member_expertise")
}

// Content attribution - who created/contributed to what
model ContentCredit {
  id              String   @id @default(cuid())
  team_member_id  String
  content_type    String   // "blog_post", "resort", "comparison", "guide"
  content_id      String   // ID of the content item
  role            CreditRole @default(AUTHOR)
  contribution    String?  // Optional description of contribution

  team_member     TeamMember @relation(fields: [team_member_id], references: [id], onDelete: Cascade)

  created_at      DateTime @default(now())

  @@unique([team_member_id, content_type, content_id])
  @@index([content_type, content_id])
  @@map("content_credits")
}

enum SkillCategory {
  ENGINEERING        // Coding, Architecture, DevOps, System Design
  AI_ML              // AI Implementation, Prompt Engineering, ML, Automation
  DESIGN             // UI/UX, Visual Design, Brand Design, Motion
  DATA               // Database Management, Analytics, BI, Data Modeling
  CONTENT            // Travel Writing, SEO Content, Copywriting, Editorial
  MARKETING          // Affiliate Marketing, Growth, Paid Media, Email
  PSYCHOLOGY         // Consumer Behavior, Persuasion, UX Research, CRO
  BUSINESS           // Strategy, Operations, Finance, Partnerships
  TRAVEL             // Destination Expertise, Hospitality, Luxury Travel
}

enum Proficiency {
  LEARNING           // Currently developing this skill
  PROFICIENT         // Solid working knowledge
  EXPERT             // Deep expertise, can lead projects
  THOUGHT_LEADER     // Industry recognition, speaker/author
}

enum CreditRole {
  AUTHOR             // Primary author
  CO_AUTHOR          // Co-authored
  EDITOR             // Edited/reviewed
  CONTRIBUTOR        // Contributed sections
  PHOTOGRAPHER       // Provided photography
  RESEARCHER         // Research contribution
  ADVISOR            // Advisory input
}

// =============================================================================
// DOMAIN MANAGEMENT SYSTEM
// =============================================================================

model Domain {
  id          String    @id @default(cuid())
  site_id     String
  hostname    String    @unique  // "arabaldives.com", "www.arabaldives.com"
  is_primary  Boolean   @default(false)
  verified    Boolean   @default(false)
  verified_at DateTime?

  // Verification
  verification_token String?  // DNS TXT record value
  verification_method String? // "dns", "file", "cname"

  // SSL
  ssl_status  String?   @default("pending") // "pending", "active", "failed"

  // Relations
  site        Site      @relation(fields: [site_id], references: [id], onDelete: Cascade)

  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@index([site_id])
  @@index([verified])
  @@map("domains")
}

// =============================================================================
// AFFILIATE TRACKING & REVENUE SYSTEM
// =============================================================================

model TrackingPartner {
  id              String   @id @default(cuid())
  name            String   // "Booking.com", "Agoda", "GetYourGuide"
  slug            String   @unique
  partner_type    PartnerType @default(HOTEL)

  // Commission structure
  commission_type String   @default("percentage") // "percentage", "fixed"
  commission_rate Float    // 4.0 = 4% or fixed amount
  cookie_days     Int      @default(30)

  // Integration
  api_url         String?
  tracking_domain String?  // "prf.hn", "booking.com"
  affiliate_id    String?

  // Status
  is_active       Boolean  @default(true)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  clicks          AffiliateClick[]
  conversions     Conversion[]

  @@map("tracking_partners")
}

model AffiliateClick {
  id              String   @id @default(cuid())
  site_id         String
  partner_id      String

  // What was clicked
  resort_id       String?
  product_id      String?
  article_id      String?
  link_type       String?  // "resort_cta", "comparison_table", "sidebar"

  // Session tracking
  session_id      String
  visitor_id      String?  // Persistent visitor ID from cookie

  // Attribution
  utm_source      String?
  utm_medium      String?
  utm_campaign    String?
  utm_content     String?
  utm_term        String?
  referrer        String?
  landing_page    String?

  // Device info
  user_agent      String?
  device_type     String?  // "mobile", "tablet", "desktop"
  country_code    String?

  // Timestamps
  clicked_at      DateTime @default(now())

  // Relations
  partner         TrackingPartner @relation(fields: [partner_id], references: [id])
  conversion      Conversion?

  @@index([site_id, clicked_at])
  @@index([partner_id])
  @@index([resort_id])
  @@index([session_id])
  @@map("affiliate_clicks")
}

model Conversion {
  id              String   @id @default(cuid())
  site_id         String
  click_id        String   @unique
  partner_id      String

  // Booking details
  booking_ref     String?  // Partner's booking reference
  booking_value   Int      // cents/pence
  commission      Int      // cents/pence
  currency        String   @default("USD")

  // Status
  status          ConversionStatus @default(PENDING)

  // Dates
  check_in        DateTime?
  check_out       DateTime?
  converted_at    DateTime @default(now())
  confirmed_at    DateTime?
  paid_at         DateTime?

  // Relations
  click           AffiliateClick @relation(fields: [click_id], references: [id])
  partner         TrackingPartner @relation(fields: [partner_id], references: [id])

  @@index([site_id, converted_at])
  @@index([status])
  @@map("conversions")
}

enum PartnerType {
  HOTEL            // Booking.com, Agoda
  EXPERIENCE       // GetYourGuide, Viator
  INSURANCE        // World Nomads, Safety Wing
  FLIGHT           // Skyscanner
  TRANSFER         // Welcome Pickups
  EQUIPMENT        // Amazon, REI
}

enum ConversionStatus {
  PENDING          // Click recorded, awaiting booking
  BOOKED           // Booking confirmed by partner
  COMPLETED        // Stay completed
  CANCELLED        // Booking cancelled
  PAID             // Commission paid out
}

// =============================================================================
// LEAD MANAGEMENT & CRM
// =============================================================================

model Lead {
  id              String   @id @default(cuid())
  site_id         String

  // Contact info
  email           String
  name            String?
  phone           String?

  // Lead type
  lead_type       LeadType @default(NEWSLETTER)
  lead_source     String?  // "exit_intent", "content_gate", "contact_form"

  // Interest data
  interests_json  Json?    // ["maldives", "honeymoon", "luxury"]
  budget_range    String?  // "$5k-10k", "$10k-20k"
  travel_dates    String?
  party_size      Int?

  // Attribution
  utm_source      String?
  utm_medium      String?
  utm_campaign    String?
  referrer        String?
  landing_page    String?

  // Lead scoring
  score           Int      @default(0)
  score_factors   Json?    // { page_views: 10, email_opens: 5 }

  // Status
  status          LeadStatus @default(NEW)
  assigned_to     String?

  // Monetization
  value           Int?     // Lead value in cents (for sold leads)
  sold_to         String?  // Partner who bought the lead
  sold_at         DateTime?

  // Consent
  marketing_consent Boolean @default(false)
  consent_ip      String?
  consent_at      DateTime?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  activities      LeadActivity[]

  @@unique([site_id, email])
  @@index([email])
  @@index([site_id, created_at])
  @@index([lead_type])
  @@index([status])
  @@index([score])
  @@map("leads")
}

model LeadActivity {
  id          String   @id @default(cuid())
  lead_id     String

  activity_type String // "page_view", "email_open", "form_submit", "click"
  activity_data Json?  // { page: "/resorts/maldives", duration: 120 }

  created_at  DateTime @default(now())

  lead        Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  @@index([lead_id, created_at])
  @@map("lead_activities")
}

enum LeadType {
  NEWSLETTER       // Newsletter signup
  GUIDE_DOWNLOAD   // Downloaded PDF guide
  TRIP_INQUIRY     // Trip planning inquiry
  QUOTE_REQUEST    // Requested resort quote
  CONSULTATION     // Booked consultation call
  CONTACT          // General contact form
}

enum LeadStatus {
  NEW              // Just captured
  QUALIFIED        // Met scoring threshold
  CONTACTED        // Outreach sent
  ENGAGED          // Responded/interacted
  CONVERTED        // Made a booking
  SOLD             // Lead sold to partner
  UNQUALIFIED      // Not a good fit
  UNSUBSCRIBED     // Opted out
}

// =============================================================================
// PAGE VIEWS & ANALYTICS TRACKING
// =============================================================================

model PageView {
  id          String   @id @default(cuid())
  site_id     String

  // Page info
  path        String
  page_type   String?  // "resort", "comparison", "article", "homepage"
  content_id  String?  // ID of the content viewed

  // Session
  session_id  String
  visitor_id  String?

  // Metrics
  duration    Int?     // seconds on page
  scroll_depth Int?    // 0-100 percentage

  // Source
  referrer    String?
  utm_source  String?

  viewed_at   DateTime @default(now())

  @@index([site_id, viewed_at])
  @@index([site_id, path])
  @@index([path])
  @@index([content_id])
  @@index([session_id])
  @@map("page_views")
}

// =============================================================================
// DIGITAL PRODUCTS & PURCHASES
// =============================================================================

model DigitalProduct {
  id              String   @id @default(cuid())
  site_id         String?  // null = available on all sites

  // Product info
  name_en         String
  name_ar         String?
  slug            String   @unique
  description_en  String   @db.Text
  description_ar  String?  @db.Text

  // Pricing (cents)
  price           Int
  compare_price   Int?     // "Was" price for anchoring
  currency        String   @default("USD")

  // Product type
  product_type    ProductType @default(PDF_GUIDE)

  // Delivery
  file_url        String?  // S3/R2 URL
  file_size       Int?     // bytes

  // Display
  cover_image     String?
  features_json   Json?    // ["50 pages", "Resort comparisons"]

  // Status
  is_active       Boolean  @default(true)
  featured        Boolean  @default(false)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  purchases       Purchase[]

  @@index([site_id])
  @@index([product_type])
  @@map("digital_products")
}

model Purchase {
  id              String   @id @default(cuid())
  site_id         String
  product_id      String

  // Customer
  customer_email  String
  customer_name   String?

  // Payment
  amount          Int      // cents
  currency        String   @default("USD")
  payment_provider String? // "stripe", "paddle"
  payment_id      String?  // External payment ID

  // Status
  status          PurchaseStatus @default(PENDING)

  // Access
  download_token  String   @unique @default(cuid())
  download_count  Int      @default(0)
  download_limit  Int      @default(5)

  // Attribution
  utm_source      String?
  utm_campaign    String?

  created_at      DateTime @default(now())
  completed_at    DateTime?

  product         DigitalProduct @relation(fields: [product_id], references: [id])

  @@index([site_id, created_at])
  @@index([customer_email])
  @@index([download_token])
  @@map("purchases")
}

enum ProductType {
  PDF_GUIDE        // Downloadable PDF
  SPREADSHEET      // Excel/Google Sheets
  TEMPLATE         // Planning templates
  BUNDLE           // Multiple products
  MEMBERSHIP       // Recurring access
}

enum PurchaseStatus {
  PENDING          // Payment initiated
  COMPLETED        // Payment successful
  FAILED           // Payment failed
  REFUNDED         // Money returned
}

// =============================================================================
// EVENTS SYSTEM
// =============================================================================

model Event {
  id            String    @id @default(cuid())
  title_en      String
  title_ar      String?
  description_en String   @db.Text
  description_ar String?  @db.Text
  date          DateTime
  time          String    // e.g. "15:00"
  venue         String
  category      String    // Football, Theatre, Festival, Exhibition, Experience
  price         String    // e.g. "From £120"
  image         String?   // URL
  rating        Float     @default(0)
  bookingUrl    String
  affiliateTag  String?   // e.g. "stubhub", "ticketmaster"
  ticketProvider String?  // Display name
  vipAvailable  Boolean   @default(false)
  soldOut       Boolean   @default(false)
  featured      Boolean   @default(false)
  published     Boolean   @default(true)
  siteId        String?
  site          Site?     @relation(fields: [siteId], references: [id])
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@index([siteId])
  @@index([date])
  @@index([category])
  @@index([published])
}

// =============================================================================
// COMPREHENSIVE DASHBOARD SYSTEM - NEW TABLES
// =============================================================================
// Note: Temporarily commented out to fix build issues
// These models will be added back once the schema is stable

// =============================================================================
// AUTOMATION TRACKING MODELS
// =============================================================================

// Per-URL indexing status — tracks each URL's journey through indexing
model URLIndexingStatus {
  id            String   @id @default(cuid())
  site_id       String
  url           String
  slug          String?  // Blog post slug for quick lookup

  // Indexing state
  status        String   @default("discovered") // discovered, submitted, indexed, deindexed, error
  coverage_state String? // GSC coverage state ("Submitted and indexed", "Crawled - currently not indexed", etc.)
  indexing_state String? // GSC indexing state ("INDEXING_ALLOWED", etc.)

  // Submission tracking
  submitted_indexnow   Boolean  @default(false)
  submitted_google_api Boolean  @default(false)
  submitted_sitemap    Boolean  @default(false)
  last_submitted_at    DateTime?

  // Inspection results
  last_inspected_at    DateTime?
  last_crawled_at      DateTime?
  inspection_result    Json?    // Full GSC URL Inspection response

  // Retry tracking
  submission_attempts  Int      @default(0)
  last_error           String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([site_id, url])
  @@index([site_id, status])
  @@index([site_id, slug])
  @@index([status])
  @@index([last_submitted_at])
  @@map("url_indexing_status")
}

// Cron job execution log — tracks every cron run for monitoring & debugging
model CronJobLog {
  id            String   @id @default(cuid())
  site_id       String?  // null for multi-site runs

  // Job identification
  job_name      String   // "seo-agent", "daily-content-generate", "weekly-topics", "daily-publish"
  job_type      String   @default("scheduled") // scheduled, manual, triggered

  // Execution
  status        String   @default("running") // running, completed, failed, timeout, partial
  started_at    DateTime @default(now())
  completed_at  DateTime?
  duration_ms   Int?

  // Results
  result_summary Json?   // { issues: 5, fixes: 3, healthScore: 72 }
  items_processed Int    @default(0)
  items_succeeded Int    @default(0)
  items_failed    Int    @default(0)

  // Error tracking
  error_message  String?  @db.Text
  error_stack    String?  @db.Text

  // Multi-site tracking
  sites_processed String[] // ["yalla-london", "arabaldives"]
  sites_skipped   String[] // Sites skipped due to timeout
  timed_out       Boolean  @default(false)

  created_at    DateTime @default(now())

  @@index([job_name, started_at])
  @@index([site_id, job_name])
  @@index([status])
  @@index([started_at])
  @@map("cron_job_logs")
}

// Periodic site health snapshots — aggregated health metrics per site
model SiteHealthCheck {
  id            String   @id @default(cuid())
  site_id       String

  // SEO health
  health_score       Int?     // 0-100 from SEO agent
  indexed_pages      Int?
  total_pages        Int?
  indexing_rate       Float?   // percentage indexed

  // GSC performance
  gsc_clicks         Int?
  gsc_impressions    Int?
  gsc_ctr            Float?
  gsc_avg_position   Float?

  // GA4 traffic
  ga4_sessions       Int?
  ga4_bounce_rate    Float?
  ga4_engagement_rate Float?
  ga4_organic_share  Float?

  // Content health
  total_posts        Int?
  posts_published    Int?
  posts_pending      Int?
  avg_seo_score      Float?

  // Automation health
  last_agent_run     DateTime?
  last_content_gen   DateTime?
  pending_proposals  Int?
  rewrite_queue      Int?

  // PageSpeed (optional)
  pagespeed_mobile   Int?
  pagespeed_desktop  Int?

  // Full snapshot data
  snapshot_data      Json?

  checked_at    DateTime @default(now())

  @@index([site_id, checked_at])
  @@index([site_id])
  @@index([checked_at])
  @@map("site_health_checks")
}

// ─── Billing & Payments ──────────────────────────────────────

/// Operating entity that owns multiple sites and holds a Stripe account
model BillingEntity {
  id                 String   @id @default(cuid())
  name               String   // e.g. "Yalla Media Group"
  email              String   @unique
  stripe_customer_id String?  @unique // Stripe Customer ID (cus_xxx)
  stripe_account_id  String?  // Stripe Connect account (for marketplace)
  default_currency   String   @default("GBP")
  country            String   @default("GB")
  vat_number         String?
  address_json       Json?    // { line1, line2, city, state, postal_code, country }
  metadata_json      Json?

  // Relations
  subscriptions      Subscription[]
  payment_methods    PaymentMethod[]
  invoices           Invoice[]

  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@map("billing_entities")
}

/// Subscription linking a billing entity to site(s)
model Subscription {
  id                    String   @id @default(cuid())
  billing_entity_id     String
  billing_entity        BillingEntity @relation(fields: [billing_entity_id], references: [id])
  stripe_subscription_id String?  @unique // sub_xxx
  stripe_price_id       String?  // price_xxx
  plan_name             String   @default("pro") // free, starter, pro, enterprise
  status                String   @default("active") // active, past_due, canceled, trialing, paused
  site_ids              String[] // site IDs covered by this subscription
  quantity              Int      @default(1) // number of sites
  current_period_start  DateTime?
  current_period_end    DateTime?
  cancel_at_period_end  Boolean  @default(false)
  trial_end             DateTime?
  metadata_json         Json?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@index([billing_entity_id])
  @@index([status])
  @@map("subscriptions")
}

/// Stored payment method (card, bank account)
model PaymentMethod {
  id                    String   @id @default(cuid())
  billing_entity_id     String
  billing_entity        BillingEntity @relation(fields: [billing_entity_id], references: [id])
  stripe_payment_method_id String? @unique // pm_xxx
  type                  String   @default("card") // card, bank_account, sepa_debit
  last4                 String?
  brand                 String?  // visa, mastercard, amex
  exp_month             Int?
  exp_year              Int?
  is_default            Boolean  @default(false)

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@index([billing_entity_id])
  @@map("payment_methods")
}

/// Invoice record (mirrors Stripe invoices)
model Invoice {
  id                    String   @id @default(cuid())
  billing_entity_id     String
  billing_entity        BillingEntity @relation(fields: [billing_entity_id], references: [id])
  stripe_invoice_id     String?  @unique // in_xxx
  number                String?  // INV-2024-001
  status                String   @default("draft") // draft, open, paid, void, uncollectible
  amount_due            Int      @default(0) // in smallest currency unit (cents/pence)
  amount_paid           Int      @default(0)
  currency              String   @default("GBP")
  period_start          DateTime?
  period_end            DateTime?
  paid_at               DateTime?
  hosted_invoice_url    String?  // Stripe-hosted invoice page
  pdf_url               String?  // Invoice PDF download
  site_ids              String[] // which sites this invoice covers
  line_items_json       Json?    // line item details
  metadata_json         Json?

  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@index([billing_entity_id])
  @@index([status])
  @@map("invoices")
}

/// ArticleDraft — Incremental content generation pipeline (Reservoir + Builder)
/// Articles are built phase-by-phase, each phase completing within a single cron invocation.
/// Only articles passing quality threshold are promoted to BlogPost for publishing.
model ArticleDraft {
  id                  String   @id @default(cuid())
  site_id             String
  keyword             String
  locale              String   @default("en")
  topic_title         String?

  // Pipeline phase tracking
  current_phase       String   @default("research")  // research, outline, drafting, assembly, images, seo, scoring, reservoir, published, rejected
  phase_attempts      Int      @default(0)
  last_error          String?
  sections_completed  Int      @default(0)           // Track how many sections drafted so far
  sections_total      Int      @default(0)           // Total sections planned by outline

  // Phase outputs (populated incrementally as phases complete)
  research_data       Json?    @db.JsonB             // SERP analysis, competitor structure, PAA questions, keyword data
  outline_data        Json?    @db.JsonB             // Structured outline: sections[], heading hierarchy, word targets, link plan
  sections_data       Json?    @db.JsonB             // Array of {heading, content, wordCount, status} per section
  assembled_html      String?  @db.Text              // Full assembled article HTML (EN or AR)
  assembled_html_alt  String?  @db.Text              // Translation (AR if locale=en, EN if locale=ar)
  seo_meta            Json?    @db.JsonB             // {metaTitle, metaDescription, schema, ogImage, keywords, internalLinks}
  images_data         Json?    @db.JsonB             // {featured: PhotoEntry, inline: PhotoEntry[], unsplash_used: boolean}

  // Quality scoring (populated in scoring phase)
  quality_score       Float?                         // Overall 0-100
  seo_score           Float?                         // SEO-specific 0-100
  word_count          Int?
  readability_score   Float?                         // Flesch-Kincaid or similar
  content_depth_score Float?                         // Topic coverage completeness

  // Source tracking
  topic_proposal_id   String?                        // FK to TopicProposal if sourced from there
  ai_model_used       String?                        // Which AI model generated each phase
  generation_strategy String?                        // "topic_db", "template_cycle", "trending", "gap_fill"

  // Bilingual pairing — EN and AR drafts reference each other
  paired_draft_id     String?                        // ID of the paired locale draft (EN→AR or AR→EN)

  // Publishing
  blog_post_id        String?                        // Set when promoted to BlogPost
  published_at        DateTime?
  rejection_reason    String?
  needs_review        Boolean  @default(true)        // Flagged for admin review after auto-publish

  // Timestamps
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  phase_started_at    DateTime?                      // When current phase began processing
  completed_at        DateTime?                      // When final phase completed

  @@index([current_phase, site_id])
  @@index([current_phase, created_at])
  @@index([quality_score])
  @@index([site_id, current_phase])
  @@index([created_at])
  @@index([paired_draft_id])
  @@map("article_drafts")
}

// ══════════════════════════════════════════════════════════════════
// Design System Models
// ══════════════════════════════════════════════════════════════════

/// Design — Canvas designs created in the Design Studio (social graphics, headers, covers, etc.)
model Design {
  id            String   @id @default(cuid())
  title         String
  description   String?
  type          String   // canvas, social-post, email-header, pdf-cover, logo, banner
  category      String?  // travel-guide, social-post, flyer, menu, itinerary, infographic, poster, brochure
  site          String   // yalla-london, arabaldives, etc.
  canvasData    Json     // Full Konva stage JSON for re-editing
  thumbnail     String?  // S3 URL of auto-generated preview thumbnail
  exportedUrls  Json?    // { png: "...", svg: "...", pdf: "..." }
  width         Int
  height        Int
  tags          String[]
  isTemplate    Boolean  @default(false)
  templateId    String?  // If created from a template, reference it
  status        String   @default("draft") // draft, published, archived
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([site, type])
  @@index([status])
  @@index([isTemplate])
  @@index([createdAt])
  @@map("designs")
}

/// PdfGuide — Generated travel PDF guides with AI content
model PdfGuide {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String?
  site            String
  style           String   // luxury, budget, family, adventure, honeymoon
  language        String   @default("en")
  contentSections Json     // Array of generated content sections
  htmlContent     String?  @db.Text // Rendered HTML
  pdfUrl          String?  // S3 URL of generated PDF binary
  coverDesignId   String?  // Link to Design for the cover
  status          String   @default("draft") // draft, generating, generated, published, failed
  price           Float?   @default(0)
  isGated         Boolean  @default(false) // Require email to download
  downloads       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pdfDownloads    PdfDownload[]

  @@index([site])
  @@index([status])
  @@index([slug])
  @@map("pdf_guides")
}

/// PdfDownload — Track PDF guide downloads for analytics and lead capture
model PdfDownload {
  id           String   @id @default(cuid())
  pdfGuideId   String
  pdfGuide     PdfGuide @relation(fields: [pdfGuideId], references: [id])
  leadId       String?
  email        String?
  ip           String?
  userAgent    String?
  downloadedAt DateTime @default(now())

  @@index([pdfGuideId])
  @@index([email])
  @@map("pdf_downloads")
}

/// EmailTemplate — Reusable email templates for campaigns and notifications
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  site        String
  type        String   // notification, campaign, welcome, transactional, newsletter
  subject     String?
  htmlContent String   @db.Text
  jsonContent Json?    // Structured block data for re-editing
  thumbnail   String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([site, type])
  @@index([isDefault])
  @@map("email_templates")
}

/// EmailCampaign — Email campaigns sent to subscribers
model EmailCampaign {
  id             String    @id @default(cuid())
  name           String
  site           String
  templateId     String?
  subject        String
  htmlContent    String    @db.Text
  recipientCount Int       @default(0)
  sentCount      Int       @default(0)
  openCount      Int       @default(0)
  clickCount     Int       @default(0)
  status         String    @default("draft") // draft, scheduled, sending, sent, failed
  scheduledAt    DateTime?
  sentAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([site])
  @@index([status])
  @@index([scheduledAt])
  @@map("email_campaigns")
}

/// VideoProject — Video compositions created in the Video Studio
model VideoProject {
  id              String   @id @default(cuid())
  title           String
  site            String
  category        String   // destination-highlight, blog-promo, hotel-showcase, etc.
  format          String   // instagram-reel, youtube-short, etc.
  language        String   @default("en")
  scenes          Json     // Array of scene configurations (for template-based)
  compositionCode String?  @db.Text // AI-generated Remotion React component code
  prompt          String?  @db.Text // Original user prompt that generated this video
  duration        Int      // Total duration in seconds
  fps             Int      @default(30)
  width           Int
  height          Int
  thumbnail       String?  // S3 URL
  exportedUrl     String?  // S3 URL of rendered MP4
  status          String   @default("draft") // draft, rendering, rendered, failed, queued
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([site])
  @@index([status])
  @@index([category])
  @@map("video_projects")
}

/// ContentPipeline — AI content engine pipeline runs (Researcher → Ideator → Scripter → Analyst)
model ContentPipeline {
  id                 String   @id @default(cuid())
  site               String
  status             String   @default("researching") // researching, ideating, scripting, analyzing, complete, paused
  topic              String?
  language           String   @default("en")
  researchData       Json?    // Researcher output: trends, audience, keywords, competitors
  contentAngles      Json?    // Ideator output: angles with cross-platform maps
  scripts            Json?    // Scripter output: platform-specific scripts + asset links
  analysisData       Json?    // Analyst output: grades, patterns, recommendations
  generatedPosts     Json?    // Array of { platform, text, designId, videoId, scheduledContentId }
  generatedArticleId String?
  generatedEmailId   String?
  generatedVideoIds  Json?
  generatedDesignIds Json?
  feedForwardApplied Json?    // Recommendations from previous pipeline that were applied
  createdBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  performance        ContentPerformance[]

  @@index([site])
  @@index([status])
  @@index([createdAt])
  @@map("content_pipelines")
}

/// ContentPerformance — Performance tracking for content pipeline outputs
model ContentPerformance {
  id             String    @id @default(cuid())
  pipelineId     String
  pipeline       ContentPipeline @relation(fields: [pipelineId], references: [id])
  platform       String    // twitter, instagram, linkedin, blog, email, tiktok, youtube
  contentType    String    // post, reel, story, article, newsletter, video
  postUrl        String?   // URL of the published post
  publishedAt    DateTime?
  impressions    Int       @default(0)
  engagements    Int       @default(0)
  clicks         Int       @default(0)
  shares         Int       @default(0)
  saves          Int       @default(0)
  comments       Int       @default(0)
  conversionRate Float?
  grade          String?   // A, B, C, D, F — set by Analyst
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([pipelineId])
  @@index([platform])
  @@index([grade])
  @@map("content_performance")
}

// ═══════════════════════════════════════════════════════════════════════════
// ZENITHA YACHTS — Yacht Charter Platform Models
// Added: Feb 21, 2026 | Site ID: zenitha-yachts-med
// ═══════════════════════════════════════════════════════════════════════════

// ─── ENUMS ──────────────────────────────────────────────────

enum YachtType {
  SAILBOAT
  CATAMARAN
  MOTOR_YACHT
  GULET
  SUPERYACHT
  POWER_CATAMARAN
}

enum YachtSource {
  NAUSYS
  MMK
  CHARTER_INDEX
  MANUAL
}

enum InquiryStatus {
  NEW
  CONTACTED
  QUALIFIED
  SENT_TO_BROKER
  BOOKED
  LOST
}

enum AvailabilityStatus {
  AVAILABLE
  BOOKED
  HOLD
  MAINTENANCE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DestinationRegion {
  MEDITERRANEAN
  ARABIAN_GULF
  RED_SEA
  INDIAN_OCEAN
  CARIBBEAN
  SOUTHEAST_ASIA
}

enum SyncStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum ItineraryDifficulty {
  EASY
  MODERATE
  ADVANCED
}

// ─── MODEL: Yacht ─────────────────────────────────────────

/// Yacht — Main yacht inventory for charter platform
model Yacht {
  id                    String              @id @default(cuid())
  externalId            String?             // ID from NauSYS/MMK/Charter Index
  source                YachtSource         @default(MANUAL)
  name                  String
  slug                  String
  type                  YachtType           @default(SAILBOAT)

  // Specs
  length                Decimal?            @db.Decimal(6,2)
  beam                  Decimal?            @db.Decimal(5,2)
  draft                 Decimal?            @db.Decimal(4,2)
  yearBuilt             Int?
  builder               String?
  model                 String?

  // Capacity
  cabins                Int                 @default(0)
  berths                Int                 @default(0)
  bathrooms             Int                 @default(0)
  crewSize              Int                 @default(0)

  // Pricing
  pricePerWeekLow       Decimal?            @db.Decimal(10,2)
  pricePerWeekHigh      Decimal?            @db.Decimal(10,2)
  currency              String              @default("EUR")

  // Content
  description_en        String?             @db.Text
  description_ar        String?             @db.Text
  features              Json?               // amenities, equipment list
  images                Json?               // array of image URLs
  waterSports           Json?               // available water sports

  // GCC Differentiators
  halalCateringAvailable Boolean            @default(false)
  familyFriendly        Boolean             @default(false)
  crewIncluded          Boolean             @default(false)

  // Location
  homePort              String?
  cruisingArea          String?

  // Ratings
  rating                Decimal?            @db.Decimal(3,2)
  reviewCount           Int                 @default(0)

  // Status
  status                String              @default("active") // active, inactive, pending_review
  featured              Boolean             @default(false)

  // Multi-site
  siteId                String
  destinationId         String?

  // Sync
  lastSyncedAt          DateTime?
  syncHash              String?             // hash for dedup

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  destination           YachtDestination?   @relation(fields: [destinationId], references: [id])
  reviews               YachtReview[]
  inquiries             CharterInquiry[]
  availability          YachtAvailability[]

  @@unique([externalId, source])
  @@index([siteId])
  @@index([destinationId])
  @@index([type])
  @@index([status, siteId])
  @@index([slug, siteId])
  @@index([pricePerWeekLow])
  @@index([halalCateringAvailable])
  @@map("yachts")
}

// ─── MODEL: YachtDestination ──────────────────────────────

/// YachtDestination — Cruising regions and destinations for charter
model YachtDestination {
  id                    String              @id @default(cuid())
  name                  String
  slug                  String
  region                DestinationRegion
  country               String?

  description_en        String?             @db.Text
  description_ar        String?             @db.Text

  seasonStart           String?             // "May"
  seasonEnd             String?             // "October"
  bestMonths            Json?               // ["June", "July", "August"]

  heroImage             String?
  galleryImages         Json?

  averagePricePerWeek   Decimal?            @db.Decimal(10,2)
  highlights            Json?               // key attractions
  weatherInfo           Json?
  marinas               Json?               // marina list with coords

  siteId                String
  status                String              @default("active")

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  yachts                Yacht[]
  itineraries           CharterItinerary[]

  @@unique([slug, siteId])
  @@index([siteId])
  @@index([region])
  @@map("yacht_destinations")
}

// ─── MODEL: CharterInquiry ────────────────────────────────

/// CharterInquiry — Lead CRM for charter inquiries
model CharterInquiry {
  id                    String              @id @default(cuid())
  referenceNumber       String?             @unique // ZY-2026-0001 format
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  whatsappNumber        String?

  destination           String?
  preferredDates        Json?               // { start, end, flexible }
  guestCount            Int                 @default(2)
  childrenCount         Int                 @default(0)
  budget                Decimal?            @db.Decimal(10,2)
  budgetCurrency        String              @default("EUR")

  yachtTypePreference   YachtType?
  preferences           Json?               // { halal, crew, watersports, privacy }
  experienceLevel       String              @default("first_time") // first_time, some, experienced
  languagePreference    String              @default("en")
  contactPreference     String              @default("email") // email, whatsapp, phone
  message               String?             @db.Text

  status                InquiryStatus       @default(NEW)
  brokerAssigned        String?
  brokerNotes           String?             @db.Text

  // Attribution
  source                String?             // organic, paid, whatsapp, referral
  utmSource             String?
  utmMedium             String?
  utmCampaign           String?

  // Links
  yachtId               String?
  siteId                String

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  yacht                 Yacht?              @relation(fields: [yachtId], references: [id])

  @@index([siteId])
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@map("charter_inquiries")
}

// ─── MODEL: YachtAvailability ─────────────────────────────

/// YachtAvailability — Booking slots per yacht (high cardinality: 100K+ rows)
model YachtAvailability {
  id                    String              @id @default(cuid())
  yachtId               String
  startDate             DateTime
  endDate               DateTime
  status                AvailabilityStatus  @default(AVAILABLE)
  priceForPeriod        Decimal?            @db.Decimal(10,2)
  currency              String              @default("EUR")
  source                YachtSource
  lastCheckedAt         DateTime            @default(now())

  createdAt             DateTime            @default(now())

  // Relations
  yacht                 Yacht               @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("yacht_availability")
}

// ─── MODEL: YachtReview ───────────────────────────────────

/// YachtReview — Guest reviews for yachts (bilingual EN/AR)
model YachtReview {
  id                    String              @id @default(cuid())
  yachtId               String
  authorName            String
  authorEmail           String?
  rating                Int                 // 1-5
  title                 String?
  content_en            String?             @db.Text
  content_ar            String?             @db.Text
  charterDate           DateTime?
  destination           String?
  verified              Boolean             @default(false)
  status                ReviewStatus        @default(PENDING)
  siteId                String

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  yacht                 Yacht               @relation(fields: [yachtId], references: [id], onDelete: Cascade)

  @@index([yachtId])
  @@index([siteId])
  @@index([status])
  @@map("yacht_reviews")
}

// ─── MODEL: CharterItinerary ──────────────────────────────

/// CharterItinerary — Pre-built sailing routes with day-by-day breakdowns
model CharterItinerary {
  id                    String              @id @default(cuid())
  title_en              String
  title_ar              String?
  slug                  String
  destinationId         String
  duration              Int                 // days
  difficulty            ItineraryDifficulty @default(EASY)

  description_en        String?             @db.Text
  description_ar        String?             @db.Text

  stops                 Json                // [{ day, port, lat, lng, activities, restaurants, notes }]
  recommendedYachtTypes Json?               // ["CATAMARAN", "SAILBOAT"]
  estimatedCost         Decimal?            @db.Decimal(10,2)
  currency              String              @default("EUR")
  bestSeason            String?
  heroImage             String?

  siteId                String
  status                String              @default("active")

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  destination           YachtDestination    @relation(fields: [destinationId], references: [id])

  @@unique([slug, siteId])
  @@index([siteId])
  @@index([destinationId])
  @@map("charter_itineraries")
}

// ─── MODEL: BrokerPartner ────────────────────────────────

/// BrokerPartner — Charter broker/partner directory
model BrokerPartner {
  id                    String              @id @default(cuid())
  companyName           String
  contactName           String?
  email                 String
  phone                 String?
  website               String?
  commissionRate        Decimal?            @db.Decimal(5,2)
  destinations          Json?               // regions they cover
  status                String              @default("active")
  totalLeadsSent        Int                 @default(0)
  totalBookings         Int                 @default(0)
  siteId                String

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([siteId])
  @@map("broker_partners")
}

// ─── MODEL: YachtSyncLog ─────────────────────────────────

/// YachtSyncLog — External API sync tracking (NauSYS/MMK/Charter Index)
model YachtSyncLog {
  id                    String              @id @default(cuid())
  source                YachtSource
  syncType              String              @default("incremental") // full, incremental
  startedAt             DateTime            @default(now())
  completedAt           DateTime?
  yachtsProcessed       Int                 @default(0)
  yachtsCreated         Int                 @default(0)
  yachtsUpdated         Int                 @default(0)
  yachtsDeactivated     Int                 @default(0)
  errors                Json?
  status                SyncStatus          @default(RUNNING)
  siteId                String

  @@index([siteId])
  @@index([source])
  @@index([startedAt])
  @@map("yacht_sync_logs")
}
